---
import Layout from '../../layouts/Layout.astro'
---

<Layout title="FilaMan - Locations">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
    <h1 style="font-size: 1.8rem; font-weight: 700; margin: 0; font-family: var(--font-serif);" data-i18n="locations.title">Locations</h1>
    <button
      id="btn-new"
      class="fm-btn fm-btn-primary"
      data-i18n="locations.addLocation"
    >
      Add Location
    </button>
  </div>
  
  <div class="fm-card" style="padding: 0; overflow: hidden;">
    <style>
      .spinner {
        display: inline-block;
        width: 1.25rem;
        height: 1.25rem;
        border: 2px solid var(--border);
        border-radius: 50%;
        border-top-color: var(--accent);
        animation: spin 1s linear infinite;
        vertical-align: middle;
        margin-right: 8px;
      }
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
    </style>
    <table class="fm-table">
      <thead>
        <tr style="background: var(--bg-soft);">
          <th data-i18n="locations.name">Name</th>
          <th data-i18n="locations.identifier">Identifier</th>
          <th style="text-align: right;" data-i18n="locations.spools">Spools</th>
          <th style="text-align: right;" data-i18n="common.actions">Actions</th>
          <th style="width: 40px;"></th>
        </tr>
      </thead>
      <tbody id="locations-table">
        <tr>
          <td colspan="5" style="text-align: center; color: var(--text-muted);" data-i18n="common.loading">Loading...</td>
        </tr>
      </tbody>
    </table>
  </div>
  
  <div id="modal-container" class="fm-modal-overlay">
    <div class="fm-card" style="width: 100%; max-width: 28rem; margin: 0 1rem; padding: 24px;">
      <h3 id="modal-title" style="font-size: 1.15rem; font-weight: 600; margin-bottom: 16px;" data-i18n="locations.addLocation">Add Location</h3>
      <form id="modal-form" style="display: flex; flex-direction: column; gap: 16px;">
        <input type="hidden" id="location-id" />
        <div>
          <label for="location-name" class="fm-label">
            <span data-i18n="locations.name">Name</span> *
          </label>
          <input
            type="text"
            id="location-name"
            required
            class="fm-input"
          />
        </div>
        <div>
          <label for="location-identifier" class="fm-label" data-i18n="locations.identifier">
            Identifier
          </label>
          <input
            type="text"
            id="location-identifier"
            class="fm-input"
          />
        </div>
        <div id="modal-error" class="fm-alert-error hidden"></div>
        <div style="display: flex; gap: 12px;">
          <button type="submit" id="modal-submit" class="fm-btn fm-btn-primary" data-i18n="common.save">
            Save
          </button>
          <button type="button" id="modal-cancel" class="fm-btn fm-btn-outline" data-i18n="common.cancel">
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- RFID Modal -->
  <div id="rfid-modal" class="fm-modal-overlay">
    <div class="fm-card" style="width: 100%; max-width: 28rem; margin: 0 1rem; padding: 24px;">
      <h3 style="font-size: 1.15rem; font-weight: 600; margin-bottom: 16px;" data-i18n="rfid.writeTag">Write RFID Tag</h3>
      <div id="rfid-content">
        <p style="margin-bottom: 16px;" id="rfid-text"></p>
        <div id="rfid-device-select-container" class="hidden">
          <label for="rfid-device-select" class="fm-label" data-i18n="rfid.selectDevice">Select Device</label>
          <select id="rfid-device-select" class="fm-select" style="margin-bottom: 16px;"></select>
        </div>
        <div id="rfid-warning" class="fm-alert fm-alert-warning hidden" style="margin-bottom: 16px;" data-i18n="rfid.tagAlreadyExistsWarning"></div>
      </div>
      <div id="rfid-status" class="fm-alert hidden" style="margin-bottom: 16px;"></div>
      <div style="display: flex; gap: 12px;">
        <button id="rfid-confirm" class="fm-btn fm-btn-primary" data-i18n="common.confirm">Confirm</button>
        <button id="rfid-cancel" class="fm-btn fm-btn-outline" data-i18n="common.cancel">Cancel</button>
      </div>
    </div>
  </div>
  
  <script>
    import { t, initI18n, translatePage } from '../../lib/i18n'
    await initI18n()

    let locations: any[] = []
    let activeDevices: any[] = []
    
    function getCsrfToken(): string {
      const match = document.cookie.match(/(?:^|;\s*)csrf_token=([^;]*)/)
      return match ? decodeURIComponent(match[1]) : ''
    }
    
    async function loadActiveDevices() {
      try {
        const res = await fetch('/api/v1/devices/active', { credentials: 'include' })
        if (res.ok) {
          activeDevices = await res.json()
        }
      } catch (e) {
        console.error('Failed to load active devices:', e)
      }
    }

    async function loadLocations() {
      try {
        const locRes = await fetch('/api/v1/locations?page_size=200', { credentials: 'include' })
        if (!locRes.ok) throw new Error('Failed to fetch locations')
        locations = await locRes.json().then(d => d.items)
        renderLocations()
      } catch (error) {
        console.error('Failed to load locations:', error)
        document.getElementById('locations-table')!.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center; color: var(--error-text);">${t('locations.failedLoad')}</td>
          </tr>
        `
      }
    }
    
    function renderLocations() {
      const tbody = document.getElementById('locations-table')!
      
      if (locations.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center; color: var(--text-muted);">
              ${t('locations.noLocations')}
            </td>
          </tr>
        `
        return
      }
      
      tbody.innerHTML = locations.map(loc => {
        const hasTag = !!loc.identifier
        const isOnline = activeDevices.length > 0
        const iconColor = hasTag ? 'color: #10b981;' : 'color: var(--text-muted);'
        const tooltip = isOnline ? t('rfid.writeTag') : t('rfid.noDeviceOnlineTooltip')
        
        const rfidIcon = `
          <td style="padding: 12px; text-align: center;" onclick="event.stopPropagation(); ${isOnline ? `window.openRfidModal(${loc.id})` : ''}">
            <button class="fm-btn" 
                    style="border: none !important; background: transparent; padding: 4px; line-height: 0; ${iconColor} ${!isOnline ? 'cursor: not-allowed; opacity: 0.6;' : ''}" 
                    title="${tooltip}"
                    ${!isOnline ? 'disabled' : ''}>
              <img src="/rfid.svg" alt="RFID" style="width: 18px; height: 18px; vertical-align: middle; filter: brightness(0) saturate(100%);">
            </button>
          </td>
        `;


        return `
        <tr style="cursor: pointer;" onclick="window.location='/spools?location_id=${loc.id}'">
          <td style="padding: 12px; font-weight: 500;">${loc.name}</td>
          <td style="padding: 12px; color: var(--text-muted); font-family: monospace; font-size: 0.85rem;">${loc.identifier || '-'}</td>
          <td style="padding: 12px; text-align: right; color: var(--text-muted);">${loc.spool_count || 0}</td>
          <td style="padding: 12px; text-align: right;" onclick="event.stopPropagation()">
            <button data-id="${loc.id}" data-name="${loc.name}" data-identifier="${loc.identifier || ''}" class="btn-edit" style="color: var(--accent); background: none; border: none; cursor: pointer; margin-right: 12px;">${t('common.edit')}</button>
            <button data-id="${loc.id}" class="btn-delete" style="color: var(--error-text); background: none; border: none; cursor: pointer;">${t('common.delete')}</button>
          </td>
          ${rfidIcon}
        </tr>
      `}).join('')
      
      translatePage()

      document.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const target = e.currentTarget as HTMLButtonElement
          openModal(
            parseInt(target.dataset.id!),
            target.dataset.name!,
            target.dataset.identifier!
          )
        })
      })
      
      document.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const target = e.currentTarget as HTMLButtonElement
          const id = parseInt(target.dataset.id!)
          
          if (!(await (window as any).__fmConfirm(t('locations.confirmDelete')))) return
          
          try {
            const response = await fetch(`/api/v1/locations/${id}`, {
              method: 'DELETE',
              headers: { 'X-CSRF-Token': getCsrfToken() },
              credentials: 'include',
            })
            
            if (!response.ok) {
              const data = await response.json()
              await (window as any).__fmAlert(data.message || t('locations.failedDelete'))
              return
            }
            
            loadLocations()
          } catch {
            await (window as any).__fmAlert(t('locations.failedDelete'))
          }
        })
      })
    }
    
    function openModal(id: number | null = null, name: string = '', identifier: string = '') {
      const container = document.getElementById('modal-container')!
      const title = document.getElementById('modal-title')!
      const idInput = document.getElementById('location-id') as HTMLInputElement
      const nameInput = document.getElementById('location-name') as HTMLInputElement
      const identifierInput = document.getElementById('location-identifier') as HTMLInputElement
      const error = document.getElementById('modal-error')!
      
      title.textContent = id ? t('locations.editLocation') : t('locations.addLocation')
      idInput.value = id ? String(id) : ''
      nameInput.value = name
      identifierInput.value = identifier
      error.classList.add('hidden')
      
      container.classList.add('open')
      nameInput.focus()
    }
    
    function closeModal() {
      document.getElementById('modal-container')!.classList.remove('open')
    }
    
    document.getElementById('btn-new')?.addEventListener('click', () => openModal())
    document.getElementById('modal-cancel')?.addEventListener('click', closeModal)
    
    document.getElementById('modal-form')?.addEventListener('submit', async (e) => {
      e.preventDefault()
      
      const id = (document.getElementById('location-id') as HTMLInputElement).value
      const name = (document.getElementById('location-name') as HTMLInputElement).value
      const identifier = (document.getElementById('location-identifier') as HTMLInputElement).value || null
      const error = document.getElementById('modal-error') as HTMLDivElement
      const submitBtn = document.getElementById('modal-submit') as HTMLButtonElement
      
      const data = { name, identifier }
      
      error.classList.add('hidden')
      submitBtn.disabled = true
      submitBtn.textContent = t('common.saving')
      
      try {
        const url = id ? `/api/v1/locations/${id}` : '/api/v1/locations'
        const method = id ? 'PATCH' : 'POST'
        
        const response = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': getCsrfToken(),
          },
          credentials: 'include',
          body: JSON.stringify(data),
        })
        
        if (!response.ok) {
          const errorData = await response.json()
          throw new Error(errorData.message || t('locations.failedSave'))
        }
        
        closeModal()
        loadLocations()
      } catch (err: any) {
        error.textContent = err.message
        error.classList.remove('hidden')
      } finally {
        submitBtn.disabled = false
        submitBtn.textContent = t('common.save')
      }
    })
    
    // RFID Modal Logic
    let currentRfidLocationId: number | null = null
    
    ;(window as any).openRfidModal = (locationId: number) => {
      currentRfidLocationId = locationId
      const modal = document.getElementById('rfid-modal')!
      const text = document.getElementById('rfid-text')!
      const deviceSelectContainer = document.getElementById('rfid-device-select-container')!
      const deviceSelect = document.getElementById('rfid-device-select') as HTMLSelectElement
      const status = document.getElementById('rfid-status')!
      const warning = document.getElementById('rfid-warning')!
      
      status.classList.add('hidden')
      
      // Check if location already has a tag
      const location = locations.find(l => l.id === locationId)
      if (location && location.identifier) {
        warning.classList.remove('hidden')
      } else {
        warning.classList.add('hidden')
      }

      if (activeDevices.length === 1) {
        text.textContent = t('rfid.confirmWrite', { device: activeDevices[0].name })
        deviceSelectContainer.classList.add('hidden')
      } else {
        text.textContent = t('rfid.selectDeviceToWrite')
        deviceSelectContainer.classList.remove('hidden')
        deviceSelect.innerHTML = activeDevices.map(d => `<option value="${d.id}">${d.name} (${d.ip_address})</option>`).join('')
      }
      
      modal.classList.add('open')
    }
    
    document.getElementById('rfid-cancel')?.addEventListener('click', () => {
      document.getElementById('rfid-modal')!.classList.remove('open')
    })
    
    document.getElementById('rfid-confirm')?.addEventListener('click', async () => {
      if (!currentRfidLocationId) return
      
      const deviceId = activeDevices.length === 1 
        ? activeDevices[0].id 
        : (document.getElementById('rfid-device-select') as HTMLSelectElement).value
      
      const device = activeDevices.find(d => String(d.id) === String(deviceId))
      if (!device) return
      
      const confirmBtn = document.getElementById('rfid-confirm') as HTMLButtonElement
      const cancelBtn = document.getElementById('rfid-cancel') as HTMLButtonElement
      const status = document.getElementById('rfid-status')!
      
      confirmBtn.disabled = true
      cancelBtn.disabled = false // Keep cancel active
      
      const maxWaitSeconds = 120
      status.className = 'fm-alert fm-alert-info rfid-write-progress'
      status.classList.remove('hidden')
      status.innerHTML = `
        <div class="message-row">
          <span class="spinner"></span>
          <span>${t('rfid.writeStarted')}</span>
        </div>
        <div class="countdown-bar">
          <div class="countdown-fill green" id="countdown-fill" style="width: 100%"></div>
        </div>
        <span class="countdown-text" id="countdown-text">${maxWaitSeconds}s</span>
      `
      
      // Handle Cancel while waiting
      let isPolling = true
      const onCancel = () => {
        isPolling = false
        confirmBtn.disabled = false
        status.classList.add('hidden')
      }
      cancelBtn.addEventListener('click', onCancel, { once: true })
      
      try {
        const response = await fetch(`/api/v1/devices/${deviceId}/write-tag`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'X-CSRF-Token': getCsrfToken()
          },
          credentials: 'include',
          body: JSON.stringify({ location_id: currentRfidLocationId }),
        })
        
        const result = await response.json()
        
        if (response.ok && result.success) {
          // Polling: Check periodically for the write status
          const maxAttempts = 60 // 60 attempts * 2 seconds = 120 seconds max wait
          let attempts = 0
          
          const pollForResult = async () => {
            if (!isPolling) return
            
            attempts++
            
            const elapsedSeconds = attempts * 2
            const remainingSeconds = 120 - elapsedSeconds
            const percentage = Math.max(0, (remainingSeconds / 120) * 100)
            
            const fill = document.getElementById('countdown-fill')
            const text = document.getElementById('countdown-text')
            
            if (fill && text) {
              fill.style.width = percentage + '%'
              text.textContent = Math.max(0, remainingSeconds) + 's'
              
              fill.className = 'countdown-fill'
              if (percentage > 66) {
                fill.classList.add('green')
              } else if (percentage > 33) {
                fill.classList.add('yellow')
              } else {
                fill.classList.add('orange')
              }
            }
            
            try {
              const statusRes = await fetch(`/api/v1/devices/${deviceId}/write-status`, { credentials: 'include' })
              if (statusRes.ok) {
                const statusData = await statusRes.json()
                
                if (statusData.status === 'success') {
                  isPolling = false
                  
                  if (statusData.removed_from) {
                    status.textContent = t('rfid.writeSuccessWithCleanup', { source: statusData.removed_from })
                  } else {
                    status.textContent = t('rfid.writeSuccess')
                  }
                  
                  status.className = 'fm-alert fm-alert-success'
                  
                  // Reload data
                  loadLocations()
                  
                  setTimeout(() => {
                    document.getElementById('rfid-modal')!.classList.remove('open')
                    confirmBtn.disabled = false
                  }, 3000)
                  return
                } else if (statusData.status === 'error') {
                  isPolling = false
                  status.textContent = statusData.error_message || t('rfid.writeError')
                  status.className = 'fm-alert fm-alert-error'
                  confirmBtn.disabled = false
                  return
                }
              }
            } catch (e) {
              console.error('Polling error:', e)
            }
            
            if (attempts >= maxAttempts) {
              isPolling = false
              status.textContent = t('rfid.deviceTimeout')
              status.className = 'fm-alert fm-alert-error'
              confirmBtn.disabled = false
            } else {
              setTimeout(pollForResult, 2000)
            }
          }
          
          setTimeout(pollForResult, 2000)
        } else {
          const msg = result.detail?.message || result.message || t('rfid.writeError')
          status.textContent = msg
          status.className = 'fm-alert fm-alert-error'
          confirmBtn.disabled = false
        }
      } catch (err) {
        status.textContent = t('rfid.writeError')
        status.className = 'fm-alert fm-alert-error'
        confirmBtn.disabled = false
      }
    })
    
    loadActiveDevices().then(() => loadLocations())
  </script>
</Layout>
