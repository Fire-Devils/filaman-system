---
import Layout from '../../layouts/Layout.astro'
---

<Layout title="FilaMan - Manufacturers">
  <style>
    .sortable { cursor: pointer; user-select: none; }
    .sortable:hover { background: var(--bg-hover); }
    .sortable::after { content: ' \2195'; opacity: 0.3; font-size: 0.8em; }
    .sortable.sort-asc::after { content: ' \2191'; opacity: 1; }
    .sortable.sort-desc::after { content: ' \2193'; opacity: 1; }
    .filter-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 16px;
      align-items: center;
    }
    .filter-bar .fm-input-search {
      flex: 1;
      min-width: 200px;
      max-width: 400px;
    }
  </style>
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
    <h1 style="font-size: 1.8rem; font-weight: 700;" data-i18n="manufacturers.title">Manufacturers</h1>
    <button id="btn-new" class="fm-btn fm-btn-primary" data-i18n="manufacturers.addManufacturer">
      Add Manufacturer
    </button>
  </div>

  <div class="filter-bar">
    <input
      type="text"
      id="filter-search"
      class="fm-input fm-input-search"
      data-i18n-placeholder="manufacturers.searchPlaceholder"
      placeholder="Search manufacturers..."
    />
    <select id="filter-material" class="fm-select" style="width: auto; min-width: 160px;">
      <option value="" data-i18n="manufacturers.allMaterials">All Materials</option>
    </select>
  </div>

  <div class="fm-card" style="padding: 0; overflow: hidden;">
    <table class="fm-table">
      <thead>
        <tr>
          <th data-i18n="manufacturers.name" data-sort="name" class="sortable">Name</th>
          <th data-i18n="manufacturers.url" data-sort="url" class="sortable">URL</th>
          <th data-i18n="manufacturers.filaments" data-sort="filament_count" class="sortable">Filaments</th>
          <th data-i18n="manufacturers.spools" data-sort="spool_count" class="sortable">Spools</th>
          <th data-i18n="manufacturers.materials">Materials</th>
          <th style="text-align: right;" data-i18n="common.actions">Actions</th>
        </tr>
      </thead>
      <tbody id="manufacturers-table">
        <tr>
          <td colspan="6" style="text-align: center; color: var(--text-muted); padding: 24px;" data-i18n="common.loading">Loading...</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Modal -->
  <div id="modal-container" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 50;">
    <div class="fm-card" style="width: 100%; max-width: 480px; margin: 16px;">
      <h3 id="modal-title" style="font-size: 1.1rem; font-weight: 600; margin-bottom: 16px;" data-i18n="manufacturers.addManufacturer">Add Manufacturer</h3>
      <form id="modal-form" style="display: grid; gap: 16px;">
        <input type="hidden" id="manufacturer-id" />
        <div>
          <label for="manufacturer-name" class="fm-label">
            <span data-i18n="manufacturers.name">Name</span> *
          </label>
          <input
            type="text"
            id="manufacturer-name"
            required
            class="fm-input"
            data-i18n-placeholder="manufacturers.namePlaceholder"
            placeholder="e.g. Bambu Lab"
          />
        </div>
        <div>
          <label for="manufacturer-url" class="fm-label" data-i18n="manufacturers.url">
            URL
          </label>
          <input
            type="url"
            id="manufacturer-url"
            class="fm-input"
            data-i18n-placeholder="manufacturers.urlPlaceholder"
            placeholder="e.g. https://bambulab.com"
          />
        </div>
        
        <!-- Spool Defaults -->
        <div class="fm-card" style="padding: 16px; margin-top: 8px;">
          <h3 class="fm-label" style="font-size: 1rem; margin-bottom: 16px; margin-top: 0; color: var(--text);">Spool Defaults</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div>
              <label for="manufacturer-empty-weight" class="fm-label" data-i18n="spools.emptySpoolWeight">
                Empty Spool Weight (g)
              </label>
              <input
                type="number"
                step="1"
                id="manufacturer-empty-weight"
                class="fm-input"
              />
            </div>
            <div>
              <label for="manufacturer-material" class="fm-label" data-i18n="spools.spoolMaterial">
                Spool Material
              </label>
              <select id="manufacturer-material" class="fm-select">
                <option value="">-</option>
                <option value="Plastic" data-i18n="spools.spoolMaterialPlastic">Plastic</option>
                <option value="Cardboard" data-i18n="spools.spoolMaterialCardboard">Cardboard</option>
                <option value="Metal" data-i18n="spools.spoolMaterialMetal">Metal</option>
                <option value="Other" data-i18n="spools.spoolMaterialOther">Other</option>
              </select>
            </div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
            <div>
              <label for="manufacturer-outer-diameter" class="fm-label" data-i18n="spools.spoolOuterDiameter">
                Spool Outer Diameter (mm)
              </label>
              <input
                type="number"
                step="0.1"
                id="manufacturer-outer-diameter"
                class="fm-input"
              />
            </div>
            <div>
              <label for="manufacturer-width" class="fm-label" data-i18n="spools.spoolWidth">
                Spool Width (mm)
              </label>
              <input
                type="number"
                step="0.1"
                id="manufacturer-width"
                class="fm-input"
              />
            </div>
          </div>
        </div>
        
        <div id="modal-error" class="fm-alert-error hidden"></div>
        <div style="display: flex; gap: 12px;">
          <button type="submit" id="modal-submit" class="fm-btn fm-btn-primary" data-i18n="common.save">
            Save
          </button>
          <button type="button" id="modal-cancel" class="fm-btn fm-btn-outline" data-i18n="common.cancel">
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Info Modal -->
  <div id="info-modal-container" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 50;">
    <div class="fm-card" style="width: 100%; max-width: 480px; margin: 16px;">
      <h3 id="info-modal-title" style="font-size: 1.1rem; font-weight: 600; margin-bottom: 16px;">Manufacturer Details</h3>
      <div id="info-modal-content" style="display: grid; gap: 12px;">
        <!-- Filled via JS -->
      </div>
      <div style="margin-top: 24px;">
        <button type="button" id="info-modal-close" class="fm-btn fm-btn-outline" style="width: 100%;" data-i18n="common.close">
          Close
        </button>
      </div>
    </div>
  </div>

  <script>
    import { t, initI18n } from '../../lib/i18n'
    await initI18n()

    let manufacturers: any[] = []
    let sortKey: string | null = null
    let sortDirection: 'asc' | 'desc' | null = null
    let searchTimeout: ReturnType<typeof setTimeout> | null = null

    function setupSortableHeaders() {
      document.querySelectorAll('th[data-sort]').forEach(th => {
        th.addEventListener('click', () => {
          const key = (th as HTMLElement).dataset.sort!
          if (sortKey === key) {
            if (sortDirection === 'asc') sortDirection = 'desc'
            else if (sortDirection === 'desc') { sortKey = null; sortDirection = null }
            else sortDirection = 'asc'
          } else {
            sortKey = key
            sortDirection = 'asc'
          }
          updateSortIndicators()
          renderManufacturers()
        })
      })
    }

    function updateSortIndicators() {
      document.querySelectorAll('th[data-sort]').forEach(th => {
        const key = (th as HTMLElement).dataset.sort!
        th.classList.remove('sort-asc', 'sort-desc')
        if (sortKey === key && sortDirection) {
          th.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc')
        }
      })
    }

    function sortManufacturers(items: any[]): any[] {
      if (!sortKey || !sortDirection) return items
      return [...items].sort((a, b) => {
        const aVal = a[sortKey] ?? ''
        const bVal = b[sortKey] ?? ''
        let cmp = 0
        if (typeof aVal === 'string') cmp = aVal.localeCompare(bVal)
        else cmp = aVal - bVal
        return sortDirection === 'asc' ? cmp : -cmp
      })
    }

    function getCsrfToken(): string {
      const match = document.cookie.match(/(?:^|;\s*)csrf_token=([^;]*)/)
      return match ? decodeURIComponent(match[1]) : ''
    }

    function getFilterValues() {
      const search = (document.getElementById('filter-search') as HTMLInputElement).value.toLowerCase().trim()
      const material = (document.getElementById('filter-material') as HTMLSelectElement).value
      return { search, material }
    }

    function filterManufacturers(items: any[]): any[] {
      const { search, material } = getFilterValues()

      return items.filter(mf => {
        // Material filter
        if (material) {
          const hasMaterial = mf.materials && mf.materials.some((m: string) => m === material)
          if (!hasMaterial) return false
        }

        // Text search across name, url, materials
        if (search) {
          const name = (mf.name || '').toLowerCase()
          const url = (mf.url || '').toLowerCase()
          const materials = (mf.materials || []).join(' ').toLowerCase()
          const haystack = `${name} ${url} ${materials}`
          if (!haystack.includes(search)) return false
        }

        return true
      })
    }

    function populateMaterialFilter(items: any[]) {
      const materialSelect = document.getElementById('filter-material') as HTMLSelectElement
      const materials = new Set<string>()
      items.forEach(mf => {
        if (mf.materials) {
          mf.materials.forEach((m: string) => materials.add(m))
        }
      })
      const sortedMaterials = [...materials].sort()
      sortedMaterials.forEach(mat => {
        const opt = document.createElement('option')
        opt.value = mat
        opt.textContent = mat
        materialSelect.appendChild(opt)
      })
    }

    async function loadManufacturers() {
      try {
        const mfRes = await fetch('/api/v1/manufacturers?page_size=200', { credentials: 'include' })
        if (!mfRes.ok) throw new Error('Failed to fetch manufacturers')
        manufacturers = await mfRes.json().then(d => d.items)
        populateMaterialFilter(manufacturers)
        renderManufacturers()
      } catch (error) {
        console.error('Failed to load manufacturers:', error)
        document.getElementById('manufacturers-table')!.innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center; color: var(--error-text); padding: 24px;">${t('manufacturers.failedLoad')}</td>
          </tr>
        `
      }
    }

    function escapeHtml(str: string): string {
      const div = document.createElement('div')
      div.textContent = str
      return div.innerHTML
    }

    function renderManufacturers() {
      const tbody = document.getElementById('manufacturers-table')!
      const filtered = filterManufacturers(manufacturers)
      const sorted = sortManufacturers(filtered)

      if (sorted.length === 0) {
        const { search, material } = getFilterValues()
        const hasFilters = search || material
        tbody.innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center; color: var(--text-muted); padding: 24px;">
              ${hasFilters ? t('manufacturers.noResults') : t('manufacturers.noManufacturers')}
            </td>
          </tr>
        `
        return
      }

      tbody.innerHTML = sorted.map(mf => `
        <tr style="cursor: pointer;" class="manufacturer-row" data-mf='${escapeHtml(JSON.stringify(mf))}'>
          <td style="font-weight: 500;">${escapeHtml(mf.name)}</td>
          <td>${mf.url ? `<a href="${escapeHtml(mf.url)}" target="_blank" rel="noopener" class="stop-prop" style="color: var(--accent); text-decoration: none;">${escapeHtml(mf.url)}</a>` : '<span style="color: var(--text-muted);">-</span>'}</td>
          <td><a href="/filaments?manufacturer_id=${mf.id}" class="stop-prop" style="color: var(--accent); text-decoration: none; font-weight: 500;">${mf.filament_count || 0}</a></td>
          <td><a href="/spools?manufacturer_id=${mf.id}" class="stop-prop" style="color: var(--accent); text-decoration: none; font-weight: 500;">${mf.spool_count || 0}</a></td>
          <td>${mf.materials && mf.materials.length > 0 ? mf.materials.map(m => escapeHtml(m)).join(', ') : '<span style="color: var(--text-muted);">-</span>'}</td>
          <td style="text-align: right; white-space: nowrap;">
            <button data-mf='${escapeHtml(JSON.stringify(mf))}' class="btn-edit fm-btn fm-btn-outline stop-prop" style="padding: 5px 12px; font-size: 0.8rem;">${t('common.edit')}</button>
            <button data-id="${mf.id}" class="btn-delete fm-btn fm-btn-danger stop-prop" style="padding: 5px 12px; font-size: 0.8rem; margin-left: 6px;">${t('common.delete')}</button>
          </td>
        </tr>
      `).join('')

      document.querySelectorAll('.manufacturer-row').forEach(row => {
        row.addEventListener('click', () => {
          const mf = JSON.parse((row as HTMLElement).dataset.mf!)
          openInfoModal(mf)
        })
      })

      document.querySelectorAll('.stop-prop').forEach(el => {
        el.addEventListener('click', (e) => e.stopPropagation())
      })

      document.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const target = e.currentTarget as HTMLButtonElement
          const mf = JSON.parse(target.dataset.mf!)
          openModal(mf)
        })
      })

      document.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const target = e.currentTarget as HTMLButtonElement
          const id = parseInt(target.dataset.id!)

          if (!(await (window as any).__fmConfirm(t('manufacturers.confirmDelete')))) return

          try {
            // First attempt to delete normally
            let response = await fetch(`/api/v1/manufacturers/${id}`, {
              method: 'DELETE',
              headers: { 'X-CSRF-Token': getCsrfToken() },
              credentials: 'include',
            })

            // If conflict (409), prompt for cascade delete
            if (response.status === 409) {
              const confirmCascade = await (window as any).__fmConfirm(
                t('manufacturers.confirmCascadeDelete'),
                { 
                  title: t('common.confirmTitle'), 
                  okLabel: t('manufacturers.forceDelete'), 
                  isDanger: true 
                }
              )

              if (!confirmCascade) return

              // Attempt to delete with force flag
              response = await fetch(`/api/v1/manufacturers/${id}?force=true`, {
                method: 'DELETE',
                headers: { 'X-CSRF-Token': getCsrfToken() },
                credentials: 'include',
              })
            }

            if (!response.ok) {
              const data = await response.json().catch(() => ({}))
              await (window as any).__fmAlert(data.detail?.message || data.message || t('manufacturers.failedDelete'))
              return
            }

            loadManufacturers()
          } catch {
            await (window as any).__fmAlert(t('manufacturers.failedDelete'))
          }
        })
      })
    }

    function openModal(mf: any = null) {
      const container = document.getElementById('modal-container')!
      const title = document.getElementById('modal-title')!
      const idInput = document.getElementById('manufacturer-id') as HTMLInputElement
      const nameInput = document.getElementById('manufacturer-name') as HTMLInputElement
      const urlInput = document.getElementById('manufacturer-url') as HTMLInputElement
      const emptyWeightInput = document.getElementById('manufacturer-empty-weight') as HTMLInputElement
      const materialInput = document.getElementById('manufacturer-material') as HTMLSelectElement
      const outerDiameterInput = document.getElementById('manufacturer-outer-diameter') as HTMLInputElement
      const widthInput = document.getElementById('manufacturer-width') as HTMLInputElement
      const error = document.getElementById('modal-error')!

      title.textContent = mf ? t('manufacturers.editManufacturer') : t('manufacturers.addManufacturer')
      idInput.value = mf ? String(mf.id) : ''
      nameInput.value = mf ? mf.name : ''
      urlInput.value = mf && mf.url ? mf.url : ''
      
      if (mf) {
        emptyWeightInput.value = mf.empty_spool_weight_g != null ? String(mf.empty_spool_weight_g) : ''
        materialInput.value = mf.spool_material || ''
        outerDiameterInput.value = mf.spool_outer_diameter_mm != null ? String(mf.spool_outer_diameter_mm) : ''
        widthInput.value = mf.spool_width_mm != null ? String(mf.spool_width_mm) : ''
      } else {
        // Default values for new manufacturer
        emptyWeightInput.value = '250'
        materialInput.value = ''
        outerDiameterInput.value = '200'
        widthInput.value = '65'
      }
      
      error.classList.add('hidden')

      container.style.display = 'flex'
      nameInput.focus()
    }

    function closeModal() {
      document.getElementById('modal-container')!.style.display = 'none'
    }

    function openInfoModal(mf: any) {
      const container = document.getElementById('info-modal-container')!
      const content = document.getElementById('info-modal-content')!
      const title = document.getElementById('info-modal-title')!

      title.textContent = mf.name

      content.innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div class="fm-card" style="padding: 12px; background: var(--bg-soft);">
            <div style="font-size: 0.75rem; color: var(--text-muted);">${t('manufacturers.filaments')}</div>
            <div style="font-size: 1.2rem; font-weight: 600;">${mf.filament_count || 0}</div>
          </div>
          <div class="fm-card" style="padding: 12px; background: var(--bg-soft);">
            <div style="font-size: 0.75rem; color: var(--text-muted);">${t('manufacturers.availableSpools')}</div>
            <div style="font-size: 1.2rem; font-weight: 600;">${mf.spool_count || 0}</div>
          </div>
          <div class="fm-card" style="padding: 12px; background: var(--bg-soft);">
            <div style="font-size: 0.75rem; color: var(--text-muted);">${t('manufacturers.archivedSpools')}</div>
            <div style="font-size: 1.2rem; font-weight: 600;">${mf.archived_spool_count || 0}</div>
          </div>
          <div class="fm-card" style="padding: 12px; background: var(--bg-soft);">
             <div style="font-size: 0.75rem; color: var(--text-muted);">${t('manufacturers.materials')}</div>
             <div style="font-size: 0.9rem; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${(mf.materials || []).join(', ')}">
               ${(mf.materials || []).join(', ') || '-'}
             </div>
          </div>
        </div>

        <div style="display: grid; gap: 12px; margin-top: 8px;">
          <div class="fm-card" style="border-left: 4px solid var(--accent); padding: 12px;">
            <div style="font-size: 0.75rem; color: var(--text-muted);">${t('manufacturers.totalValueAvailable')}</div>
            <div style="font-size: 1.4rem; font-weight: 700; color: var(--accent);">${(mf.total_price_available || 0).toFixed(2)}</div>
          </div>
          <div class="fm-card" style="border-left: 4px solid var(--text-muted); padding: 12px;">
            <div style="font-size: 0.75rem; color: var(--text-muted);">${t('manufacturers.totalSpentAllTime')}</div>
            <div style="font-size: 1.4rem; font-weight: 700;">${(mf.total_price_all || 0).toFixed(2)}</div>
          </div>
        </div>
      `

      container.style.display = 'flex'
    }

    function closeInfoModal() {
      document.getElementById('info-modal-container')!.style.display = 'none'
    }

    document.getElementById('btn-new')?.addEventListener('click', () => openModal())
    document.getElementById('modal-cancel')?.addEventListener('click', closeModal)
    document.getElementById('info-modal-close')?.addEventListener('click', closeInfoModal)

    // Close modals on backdrop click
    document.getElementById('modal-container')?.addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeModal()
    })
    document.getElementById('info-modal-container')?.addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeInfoModal()
    })

    // Close modals on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeModal()
        closeInfoModal()
      }
    })

    document.getElementById('modal-form')?.addEventListener('submit', async (e) => {
      e.preventDefault()

      const id = (document.getElementById('manufacturer-id') as HTMLInputElement).value
      const name = (document.getElementById('manufacturer-name') as HTMLInputElement).value
      const url = (document.getElementById('manufacturer-url') as HTMLInputElement).value || null
      const emptyWeight = (document.getElementById('manufacturer-empty-weight') as HTMLInputElement).value
      const material = (document.getElementById('manufacturer-material') as HTMLSelectElement).value || null
      const outerDiameter = (document.getElementById('manufacturer-outer-diameter') as HTMLInputElement).value
      const width = (document.getElementById('manufacturer-width') as HTMLInputElement).value
      const error = document.getElementById('modal-error') as HTMLDivElement
      const submitBtn = document.getElementById('modal-submit') as HTMLButtonElement

      const data: Record<string, any> = { 
        name,
        url,
        empty_spool_weight_g: emptyWeight ? parseFloat(emptyWeight) : null,
        spool_material: material,
        spool_outer_diameter_mm: outerDiameter ? parseFloat(outerDiameter) : null,
        spool_width_mm: width ? parseFloat(width) : null
      }

      error.classList.add('hidden')
      submitBtn.disabled = true
      submitBtn.textContent = t('common.saving')

      try {
        const apiUrl = id ? `/api/v1/manufacturers/${id}` : '/api/v1/manufacturers'
        const method = id ? 'PATCH' : 'POST'

        const response = await fetch(apiUrl, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': getCsrfToken(),
          },
          credentials: 'include',
          body: JSON.stringify(data),
        })

        if (!response.ok) {
          const errorData = await response.json()
          throw new Error(errorData.detail?.message || errorData.message || t('manufacturers.failedSave'))
        }

        closeModal()
        loadManufacturers()
      } catch (err: any) {
        error.textContent = err.message
        error.classList.remove('hidden')
      } finally {
        submitBtn.disabled = false
        submitBtn.textContent = t('common.save')
      }
    })

    // Wire up filter events
    document.getElementById('filter-search')?.addEventListener('input', () => {
      if (searchTimeout) clearTimeout(searchTimeout)
      searchTimeout = setTimeout(() => renderManufacturers(), 250)
    })
    document.getElementById('filter-material')?.addEventListener('change', () => renderManufacturers())

    setupSortableHeaders()
    loadManufacturers()
  </script>
</Layout>
