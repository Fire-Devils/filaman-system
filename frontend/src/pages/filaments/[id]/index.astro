---
import Layout from '../../../layouts/Layout.astro'

export function getStaticPaths() {
  return [
    {params: {id: 'detail'}},
  ];
}

const { id } = Astro.params
---

<Layout title="FilaMan - Filament">
  <div style="margin-bottom: 24px;">
    <a href="/filaments" style="color: var(--accent); text-decoration: none;">&larr; <span data-i18n="filaments.backToFilaments">Back to Filaments</span></a>
  </div>
  
  <div id="filament-content">
    <p style="color: var(--text-muted);" data-i18n="common.loading">Loading...</p>
  </div>

  <div id="spools-section" class="hidden" style="margin-top: 32px;">
    <h2 style="font-weight: 600; margin-bottom: 16px;" data-i18n="filaments.spools">Spools</h2>
    <div class="fm-card" style="padding: 0; overflow: hidden;">
      <table class="fm-table">
        <thead>
          <tr style="background: var(--bg-soft);">
            <th data-i18n="spools.id">ID</th>
            <th data-i18n="spools.status">Status</th>
            <th data-i18n="spools.remaining">Remaining</th>
            <th data-i18n="spools.location">Location</th>
          </tr>
        </thead>
        <tbody id="spools-table">
          <tr>
            <td colspan="4" style="text-align: center; color: var(--text-muted);" data-i18n="common.loading">Loading...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div id="price-summary" class="hidden" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 32px;">
    <div class="fm-card" style="border-left: 4px solid var(--accent);">
      <div style="font-size: 0.85rem; color: var(--text-muted);" data-i18n="filaments.totalValueAvailable">Total Value (available)</div>
      <div id="total-available-price" style="font-size: 1.4rem; font-weight: 700; color: var(--accent);">0.00</div>
    </div>
    <div class="fm-card" style="border-left: 4px solid var(--text-muted);">
      <div style="font-size: 0.85rem; color: var(--text-muted);" data-i18n="filaments.totalSpentAllTime">Total Spent (all time)</div>
      <div id="total-spent-price" style="font-size: 1.4rem; font-weight: 700;">0.00</div>
    </div>
  </div>
  
  <div id="price-history-section" class="hidden" style="margin-top: 32px; margin-bottom: 32px;">
    <h2 style="font-weight: 600; margin-bottom: 16px;" data-i18n="filaments.priceHistory">Price History</h2>
    <div class="fm-card" style="padding: 24px;">
      <div style="height: 300px; width: 100%;">
        <canvas id="priceChart"></canvas>
      </div>
    </div>
  </div>
  
  <script src="/vendor/chart.min.js"></script>
  <script>
    import { t, initI18n } from '../../../lib/i18n'
    await initI18n()

    const id = window.location.pathname.split('/').filter(Boolean).pop()!
    if (id === 'detail') {
      window.location.href = '/filaments'
    }

    let statuses: any[] = []
    let locations: any[] = []

    const finishLabels: Record<string, string> = {
      solid: 'filaments.finishSolid',
      translucent: 'filaments.finishTranslucent',
      neon: 'filaments.finishNeon',
      glow: 'filaments.finishGlow',
    }

    const colorModeLabels: Record<string, string> = {
      single: 'filaments.colorModeSingle',
      multi: 'filaments.colorModeMulti',
    }

    const multiStyleLabels: Record<string, string> = {
      striped: 'filaments.styleStriped',
      gradient: 'filaments.styleGradient',
    }

    async function loadFilament() {
      try {
        const response = await fetch(`/api/v1/filaments/${id}`, {
          credentials: 'include',
        })
        
        if (!response.ok) {
          if (response.status === 404) {
            document.getElementById('filament-content')!.innerHTML = `
              <div style="color: var(--error-text);">${t('filaments.notFound')}</div>
            `
            return
          }
          throw new Error('Failed to fetch filament')
        }
        
        const filament = await response.json()
        renderFilament(filament)
        loadSpools(filament.id)
      } catch (error) {
        console.error('Failed to load filament:', error)
        document.getElementById('filament-content')!.innerHTML = `
          <div style="color: var(--error-text);">${t('filaments.failedLoadSingle')}</div>
        `
      }
    }

    function renderColorSwatches(colors: any[]): string {
      if (!colors || colors.length === 0) return '-'
      return colors.map(fc => {
        const c = fc.color
        if (!c) return ''
        const label = fc.display_name_override || c.name
        return `<span style="display: inline-flex; align-items: center; gap: 6px; margin-right: 10px;">
          <span style="display: inline-block; width: 22px; height: 22px; border-radius: 50%; background: ${c.hex_code}; border: 2px solid var(--border); vertical-align: middle;"></span>
          <span>${label}</span>
        </span>`
      }).join('')
    }

    function renderDetailCard(label: string, value: string): string {
      return `<div class="fm-card">
        <div style="font-size: 0.85rem; color: var(--text-muted);">${label}</div>
        <div style="font-size: 1.1rem; font-weight: 600;">${value}</div>
      </div>`
    }
    
    function renderFilament(f: any) {
      // Build the secondary info cards grid
      const cards: string[] = []
      cards.push(renderDetailCard(t('filaments.type'), f.type))
      if (f.material_subgroup) {
        cards.push(renderDetailCard(t('filaments.materialSubgroup'), f.material_subgroup))
      }
      cards.push(renderDetailCard(t('filaments.diameter'), f.diameter_mm + 'mm'))
      if (f.finish_type) {
        const finishKey = finishLabels[f.finish_type]
        cards.push(renderDetailCard(t('filaments.finishType'), finishKey ? t(finishKey) : f.finish_type))
      }
      cards.push(renderDetailCard(t('filaments.rawMaterial'), f.raw_material_weight_g ? f.raw_material_weight_g + 'g' : '-'))
      cards.push(renderDetailCard(t('filaments.spoolWeight'), f.default_spool_weight_g ? f.default_spool_weight_g + 'g' : '-'))
      if (f.price != null) {
        cards.push(renderDetailCard(t('filaments.price'), f.price.toFixed(2)))
      }
      if (f.density_g_cm3 != null) {
        cards.push(renderDetailCard(t('filaments.density'), f.density_g_cm3.toString()))
      }

      // Color mode info
      const colorModeKey = colorModeLabels[f.color_mode]
      let colorModeDisplay = colorModeKey ? t(colorModeKey) : f.color_mode
      if (f.color_mode === 'multi' && f.multi_color_style) {
        const styleKey = multiStyleLabels[f.multi_color_style]
        colorModeDisplay += ` (${styleKey ? t(styleKey) : f.multi_color_style})`
      }

      // Colors section
      const colorsHtml = f.colors && f.colors.length > 0
        ? `<div class="fm-card" style="margin-top: 16px;">
            <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 8px;">
              ${t('filaments.colors')} &mdash; ${colorModeDisplay}
            </div>
            <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
              ${renderColorSwatches(f.colors)}
            </div>
          </div>`
        : ''

      // Manufacturer color name
      const mfgColorHtml = f.manufacturer_color_name
        ? `<div class="fm-card" style="margin-top: 16px;">
            <div style="font-size: 0.85rem; color: var(--text-muted);">${t('filaments.manufacturerColorName')}</div>
            <div style="font-size: 1.1rem; font-weight: 600;">${f.manufacturer_color_name}</div>
          </div>`
        : ''

      // Shop URL
      const shopHtml = f.shop_url
        ? `<div class="fm-card" style="margin-top: 16px;">
            <div style="font-size: 0.85rem; color: var(--text-muted);">${t('filaments.shopUrl')}</div>
            <div style="font-size: 1.1rem;">
              <a href="${f.shop_url}" target="_blank" rel="noopener noreferrer" style="color: var(--accent); word-break: break-all;">${f.shop_url}</a>
            </div>
          </div>`
        : ''

      // Custom Fields
      let customFieldsHtml = ''
      if (f.custom_fields && Object.keys(f.custom_fields).length > 0) {
        // Simple flatten for display
        const flatten = (obj, prefix = '', res = {}) => {
          for (const key in obj) {
            if (Object.prototype.hasOwnProperty.call(obj, key)) {
              const val = obj[key];
              const newKey = prefix ? `${prefix}.${key}` : key;
              if (typeof val === 'object' && val !== null) {
                flatten(val, newKey, res);
              } else {
                res[newKey] = val;
              }
            }
          }
          return res;
        }

        const flatFields = flatten(f.custom_fields)
        const rows = Object.entries(flatFields).map(([key, value]) => {
          return `
          <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border);">
            <span style="color: var(--text-muted); font-weight: 500;">${key}</span>
            <span style="font-family: monospace; word-break: break-all;">${value}</span>
          </div>
          `
        }).join('')
        
        customFieldsHtml = `
          <div class="fm-card" style="margin-top: 16px;">
            <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 8px;" data-i18n="common.extraFields">Extra Fields</div>
            <div>${rows}</div>
          </div>
        `
      }

      document.getElementById('filament-content')!.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px;">
          <div>
            <h1 style="font-size: 1.8rem; font-weight: 700; margin: 0; font-family: var(--font-serif);">${f.designation}</h1>
            <p style="color: var(--text-muted); margin: 4px 0 0;">${f.manufacturer?.name || t('filaments.unknownManufacturer')}</p>
          </div>
          <div style="display: flex; gap: 8px;">
            <a href="/filaments/${f.id}/edit" class="fm-btn fm-btn-outline">
              ${t('common.edit')}
            </a>
            <button id="btn-delete-filament" class="fm-btn fm-btn-danger">
              ${t('common.delete')}
            </button>
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px;">
          ${cards.join('\n')}
        </div>

        ${colorsHtml}
        ${mfgColorHtml}
        ${shopHtml}
        ${customFieldsHtml}
      `

      document.getElementById('btn-delete-filament')?.addEventListener('click', async () => {
        if (!(await (window as any).__fmConfirm(t('filaments.confirmDelete')))) return

        function getCsrfToken(): string {
          const match = document.cookie.match(/(?:^|;\s*)csrf_token=([^;]*)/)
          return match ? decodeURIComponent(match[1]) : ''
        }

        try {
          // First attempt to delete normally
          let response = await fetch(`/api/v1/filaments/${f.id}`, {
            method: 'DELETE',
            headers: { 'X-CSRF-Token': getCsrfToken() },
            credentials: 'include',
          })

          // If conflict (409), prompt for cascade delete
          if (response.status === 409) {
            const confirmCascade = await (window as any).__fmConfirm(
              t('filaments.confirmCascadeDelete'),
              { 
                title: t('common.confirmTitle'), 
                okLabel: t('common.delete'), 
                isDanger: true 
              }
            )

            if (!confirmCascade) return

            // Attempt to delete with force flag
            response = await fetch(`/api/v1/filaments/${f.id}?force=true`, {
              method: 'DELETE',
              headers: { 'X-CSRF-Token': getCsrfToken() },
              credentials: 'include',
            })
          }

          if (!response.ok) {
            const data = await response.json().catch(() => ({}))
            await (window as any).__fmAlert(data.detail?.message || data.message || t('filaments.failedDelete'))
            return
          }

          window.location.href = '/filaments'
        } catch {
          await (window as any).__fmAlert(t('filaments.failedDelete'))
        }
      })
    }
    
    async function loadSpools(filamentId: number) {
      try {
        const [spoolsRes, statusesRes, locationsRes] = await Promise.all([
          fetch(`/api/v1/spools?filament_id=${filamentId}&page_size=200&include_archived=true`, { credentials: 'include' }),
          fetch('/api/v1/spools/statuses', { credentials: 'include' }),
          fetch('/api/v1/locations', { credentials: 'include' }),
        ])
        
        if (!spoolsRes.ok) throw new Error('Failed to fetch spools')
        
        if (statusesRes.ok) {
          const statusData = await statusesRes.json()
          statuses = statusData.items || statusData || []
        }
        
        if (locationsRes.ok) {
          const locationData = await locationsRes.json()
          locations = locationData.items || locationData || []
        }
        
        const data = await spoolsRes.json()
        const allSpools = data.items
        
        // Find archived status ID
        const archivedStatus = statuses.find(s => s.key === 'archived')
        const archivedStatusId = archivedStatus ? archivedStatus.id : -1

        // 1. Render Table (exclude archived)
        const activeSpools = allSpools.filter(s => s.status_id !== archivedStatusId)
        document.getElementById('spools-section')!.classList.remove('hidden')
        renderSpools(activeSpools)

        // 2. Render Chart (include archived)
        renderPriceChart(allSpools)

        // 3. Calculate and render Price Summary
        renderPriceSummary(allSpools, archivedStatusId)

      } catch (error) {
        console.error('Failed to load spools:', error)
      }
    }

    function renderPriceSummary(spools: any[], archivedStatusId: number) {
      let totalSpent = 0
      let totalAvailable = 0
      let hasPrices = false

      spools.forEach(s => {
        if (s.purchase_price != null) {
          hasPrices = true
          totalSpent += s.purchase_price
          if (s.status_id !== archivedStatusId) {
            totalAvailable += s.purchase_price
          }
        }
      })

      if (hasPrices) {
        document.getElementById('price-summary')!.classList.remove('hidden')
        document.getElementById('total-available-price')!.textContent = totalAvailable.toFixed(2)
        document.getElementById('total-spent-price')!.textContent = totalSpent.toFixed(2)
      }
    }
    
    function getStatusLabel(statusId: number): string {
      const s = statuses.find((s: any) => s.id === statusId)
      if (!s) return `#${statusId}`
      const i18nKey = `spools.status${s.key.charAt(0).toUpperCase() + s.key.slice(1)}`
      return t(i18nKey) || s.label
    }
    
    function getLocationName(locationId: number | null): string {
      if (!locationId) return '-'
      const l = locations.find(l => l.id === locationId)
      return l ? l.name : `#${locationId}`
    }
    
    function renderSpools(spools: any[]) {
      const tbody = document.getElementById('spools-table')!
      
      if (spools.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="4" style="text-align: center; color: var(--text-muted);">
              ${t('filaments.noSpools')} <a href="/spools/new?filament_id=${id}" style="color: var(--accent);">${t('filaments.addOne')}</a>.
            </td>
          </tr>
        `
        return
      }
      
      tbody.innerHTML = spools.map(s => `
        <tr style="cursor: pointer;" onclick="window.location='/spools/${s.id}'">
          <td style="padding: 12px; font-weight: 500;">${t('spools.spoolId', { id: s.id })}</td>
          <td style="padding: 12px;">${getStatusLabel(s.status_id)}</td>
          <td style="padding: 12px; ${s.remaining_weight_g !== null && s.remaining_weight_g <= s.low_weight_threshold_g ? 'color: var(--accent-3); font-weight: 500;' : ''}">
            ${s.remaining_weight_g !== null ? s.remaining_weight_g.toFixed(0) + 'g' : '-'}
          </td>
          <td style="padding: 12px; color: var(--text-muted);">${getLocationName(s.location_id)}</td>
        </tr>
      `).join('')
    }

    function renderPriceChart(spools: any[]) {
      const priceData = spools
        .filter(s => s.purchase_price != null)
        .map(s => ({
          date: new Date(s.purchase_date || s.stocked_in_at || s.created_at),
          price: s.purchase_price
        }))
        .filter(d => !isNaN(d.date.getTime()))
        .sort((a, b) => a.date.getTime() - b.date.getTime())

      if (priceData.length === 0) return

      document.getElementById('price-history-section')!.classList.remove('hidden')

      const ctx = (document.getElementById('priceChart') as HTMLCanvasElement).getContext('2d')
      if (!ctx) return

      // @ts-ignore - Chart is loaded via CDN
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: priceData.map(d => d.date.toLocaleDateString()),
          datasets: [{
            label: t('filaments.price') || 'Price',
            data: priceData.map(d => d.price),
            borderColor: '#3b82f6', // var(--accent) fallback
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            borderWidth: 2,
            tension: 0.3,
            fill: true,
            pointBackgroundColor: '#3b82f6',
            pointRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: (context: any) => {
                  return `${context.parsed.y.toFixed(2)}`
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: false,
              grid: {
                color: 'rgba(156, 163, 175, 0.1)'
              },
              ticks: {
                callback: (value: any) => value.toFixed(2)
              }
            },
            x: {
              grid: {
                display: false
              }
            }
          }
        }
      })
    }
    
    loadFilament()
  </script>
</Layout>
