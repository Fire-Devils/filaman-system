---
import Layout from '../../layouts/Layout.astro'
---

<Layout title="FilaMan - Spools">
  <style>
    .sortable { cursor: pointer; user-select: none; }
    .sortable:hover { background: var(--bg-hover); }
    .sortable::after { content: ' \2195'; opacity: 0.3; font-size: 0.8em; }
    .sortable.sort-asc::after { content: ' \2191'; opacity: 1; }
    .sortable.sort-desc::after { content: ' \2193'; opacity: 1; }
    .filter-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 16px;
      align-items: center;
    }
    .filter-bar .fm-input-search {
      flex: 1;
      min-width: 200px;
      max-width: 400px;
    }
    .spinner {
      display: inline-block;
      width: 1.25rem;
      height: 1.25rem;
      border: 2px solid var(--border);
      border-radius: 50%;
      border-top-color: var(--accent);
      animation: spin 1s linear infinite;
      vertical-align: middle;
      margin-right: 8px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  
  </style>
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
    <h1 style="font-size: 1.8rem; font-weight: 700; margin: 0; font-family: var(--font-serif);" data-i18n="spools.title">Spools</h1>
    <a href="/spools/new" class="fm-btn fm-btn-primary" data-i18n="spools.addSpool">
      Add Spool
    </a>
  </div>
  
  <div class="filter-bar">
    <input
      type="text"
      id="filter-search"
      class="fm-input fm-input-search"
      data-i18n-placeholder="spools.searchPlaceholder"
      placeholder="Search filament, manufacturer..."
    />
    <select id="filter-status" class="fm-select" style="width: auto; min-width: 160px;">
      <option value="" data-i18n="spools.allStatuses">All Statuses</option>
    </select>
    <select id="filter-location" class="fm-select" style="width: auto; min-width: 160px;">
      <option value="" data-i18n="spools.allLocations">All Locations</option>
    </select>
    <select id="filter-manufacturer" class="fm-select" style="width: auto; min-width: 160px;">
      <option value="" data-i18n="spools.allManufacturers">All Manufacturers</option>
    </select>
    <select id="filter-material" class="fm-select" style="width: auto; min-width: 140px;">
      <option value="" data-i18n="spools.allMaterials">All Materials</option>
    </select>
    <label style="display: flex; align-items: center; gap: 10px; font-size: 0.85rem; cursor: pointer; white-space: nowrap;">
      <input type="checkbox" id="filter-group" class="fm-checkbox" />
      <span data-i18n="spools.groupByFilament">Group by Filament</span>
    </label>
  </div>
  
  <div class="fm-card" style="padding: 0; overflow: hidden;">
    <table class="fm-table">
      <thead>
        <tr style="background: var(--bg-soft);">
          <th data-i18n="spools.id" data-sort="id" class="sortable">ID</th>
          <th data-i18n="spools.filament" data-sort="filament_id" class="sortable">Filament</th>
          <th data-i18n="spools.manufacturer" data-sort="manufacturer" class="sortable">Manufacturer</th>
          <th data-i18n="spools.material" data-sort="material" class="sortable">Material</th>
          <th data-i18n="spools.status" data-sort="status_id" class="sortable">Status</th>
          <th data-i18n="spools.remaining" data-sort="remaining_weight_g" class="sortable">Remaining</th>
          <th data-i18n="spools.location" data-sort="location_id" class="sortable">Location</th>
          <th style="width: 40px;"></th>
        </tr>
      </thead>
      <tbody id="spools-table">
        <tr>
          <td colspan="8" style="text-align: center; color: var(--text-muted);" data-i18n="common.loading">Loading...</td>
        </tr>
      </tbody>
    </table>
  </div>
  
  <div id="pagination" style="margin-top: 16px; display: flex; justify-content: space-between; align-items: center;"></div>
  
  <!-- RFID Modal -->
  <div id="rfid-modal" class="fm-modal-overlay">
    <div class="fm-card" style="width: 100%; max-width: 28rem; margin: 0 1rem; padding: 24px;">
      <h3 style="font-size: 1.15rem; font-weight: 600; margin-bottom: 16px;" data-i18n="rfid.writeTag">Write RFID Tag</h3>
      <div id="rfid-content">
        <p style="margin-bottom: 16px;" id="rfid-text"></p>
        <div id="rfid-device-select-container" class="hidden">
          <label for="rfid-device-select" class="fm-label" data-i18n="rfid.selectDevice">Select Device</label>
          <select id="rfid-device-select" class="fm-select" style="margin-bottom: 16px;"></select>
        </div>
        <div id="rfid-warning" class="fm-alert fm-alert-warning hidden" style="margin-bottom: 16px;" data-i18n="rfid.tagAlreadyExistsWarning"></div>
      </div>
      <div id="rfid-status" class="fm-alert hidden" style="margin-bottom: 16px;"></div>
      <div style="display: flex; gap: 12px;">
        <button id="rfid-confirm" class="fm-btn fm-btn-primary" data-i18n="common.confirm">Confirm</button>
        <button id="rfid-cancel" class="fm-btn fm-btn-outline" data-i18n="common.cancel">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    import { t, initI18n, translatePage } from '../../lib/i18n'
    await initI18n()

    let currentPage = 1
    const pageSize = 50
    let statuses: any[] = []
    let locations: any[] = []
    let filaments: any[] = []
    let manufacturers: any[] = []
    let allSpools: any[] = []
    let filteredSpools: any[] = []
    let activeDevices: any[] = []
    let sortKey: string | null = null
    let sortDirection: 'asc' | 'desc' | null = null
    let filterManufacturerId: string | null = null
    let filterLocationId: string | null = null
    let filterMaterial: string | null = null
    let searchTimeout: ReturnType<typeof setTimeout> | null = null

    const urlParams = new URLSearchParams(window.location.search)
    filterManufacturerId = urlParams.get('manufacturer_id')
    filterLocationId = urlParams.get('location_id')
    filterMaterial = urlParams.get('material')

    function getCsrfToken(): string {
      const match = document.cookie.match(/(?:^|;\s*)csrf_token=([^;]*)/)
      return match ? decodeURIComponent(match[1]) : ''
    }

    function setupSortableHeaders() {
      document.querySelectorAll('th[data-sort]').forEach(th => {
        th.addEventListener('click', () => {
          const key = (th as HTMLElement).dataset.sort!
          if (sortKey === key) {
            if (sortDirection === 'asc') sortDirection = 'desc'
            else if (sortDirection === 'desc') { sortKey = null; sortDirection = null }
            else sortDirection = 'asc'
          } else {
            sortKey = key
            sortDirection = 'asc'
          }
          updateSortIndicators()
          applyFiltersAndRender()
        })
      })
    }

    function updateSortIndicators() {
      document.querySelectorAll('th[data-sort]').forEach(th => {
        const key = (th as HTMLElement).dataset.sort!
        th.classList.remove('sort-asc', 'sort-desc')
        if (sortKey === key && sortDirection) {
          th.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc')
        }
      })
    }

    function getFilamentForSpool(spool: any): any {
      return filaments.find(f => f.id === spool.filament_id) || null
    }

    function getManufacturerName(spool: any): string {
      const fil = getFilamentForSpool(spool)
      if (!fil) return '-'
      return fil.manufacturer?.name || '-'
    }

    function getMaterialType(spool: any): string {
      const fil = getFilamentForSpool(spool)
      return fil ? fil.type : '-'
    }

    function getSortValue(item: any, key: string): any {
      if (key === 'filament_id') return getFilamentName(item.filament_id)
      if (key === 'status_id') return getStatusLabel(item.status_id)
      if (key === 'location_id') return getLocationName(item.location_id)
      if (key === 'manufacturer') return getManufacturerName(item)
      if (key === 'material') return getMaterialType(item)
      return item[key]
    }

    function sortSpools(spools: any[]): any[] {
      if (!sortKey || !sortDirection) return spools
      return [...spools].sort((a, b) => {
        const aVal = getSortValue(a, sortKey)
        const bVal = getSortValue(b, sortKey)
        let cmp = 0
        if (aVal == null && bVal == null) cmp = 0
        else if (aVal == null) cmp = 1
        else if (bVal == null) cmp = -1
        else if (typeof aVal === 'string') cmp = aVal.localeCompare(bVal)
        else cmp = aVal - bVal
        return sortDirection === 'asc' ? cmp : -cmp
      })
    }

    function getFilterValues() {
      const search = (document.getElementById('filter-search') as HTMLInputElement).value.toLowerCase().trim()
      const statusId = (document.getElementById('filter-status') as HTMLSelectElement).value
      const locationId = (document.getElementById('filter-location') as HTMLSelectElement).value
      const manufacturerId = (document.getElementById('filter-manufacturer') as HTMLSelectElement).value
      const material = (document.getElementById('filter-material') as HTMLSelectElement).value
      const groupBy = (document.getElementById('filter-group') as HTMLInputElement).checked
      return { search, statusId, locationId, manufacturerId, material, groupBy }
    }

    function filterSpools(spools: any[]): any[] {
      const { search, statusId, locationId, manufacturerId, material } = getFilterValues()

      return spools.filter(s => {
        if (statusId && String(s.status_id) !== statusId) return false
        if (locationId && String(s.location_id) !== locationId) return false
        if (manufacturerId) {
          const fil = getFilamentForSpool(s)
          if (!fil || String(fil.manufacturer_id) !== manufacturerId) return false
        }
        if (material) {
          const fil = getFilamentForSpool(s)
          if (!fil || fil.type !== material) return false
        }
        if (search) {
          const fil = getFilamentForSpool(s)
          const filName = fil ? (fil.designation || '').toLowerCase() : ''
          const filType = fil ? (fil.type || '').toLowerCase() : ''
          const mfName = fil?.manufacturer?.name ? fil.manufacturer.name.toLowerCase() : ''
          const mfColorName = fil ? (fil.manufacturer_color_name || '').toLowerCase() : ''
          const colorNames = fil && fil.colors ? fil.colors.map((fc: any) => {
            const parts: string[] = []
            if (fc.color?.name) parts.push(fc.color.name.toLowerCase())
            if (fc.display_name_override) parts.push(fc.display_name_override.toLowerCase())
            return parts.join(' ')
          }).join(' ') : ''
          const locationName = getLocationName(s.location_id).toLowerCase()
          const statusLabel = getStatusLabel(s.status_id).toLowerCase()

          const haystack = `${filName} ${filType} ${mfName} ${mfColorName} ${colorNames} ${locationName} ${statusLabel}`
          if (!haystack.includes(search)) return false
        }
        return true
      })
    }

    function applyFiltersAndRender() {
      filteredSpools = filterSpools(allSpools)
      currentPage = 1
      renderPage()
    }

    function renderPage() {
      const { groupBy } = getFilterValues()
      const sorted = sortSpools(filteredSpools)

      if (groupBy) {
        renderGroupedSpools(sorted)
        const container = document.getElementById('pagination')!
        container.innerHTML = `<div style="font-size: 0.85rem; color: var(--text-muted);">${t('spools.spoolCount', { count: filteredSpools.length })}</div>`
      } else {
        const startIdx = (currentPage - 1) * pageSize
        const pageItems = sorted.slice(startIdx, startIdx + pageSize)
        renderSpools(pageItems)
        renderPagination(filteredSpools.length, currentPage)
      }
    }

    function populateFilterDropdowns() {
      const mfSelect = document.getElementById('filter-manufacturer') as HTMLSelectElement
      const mfMap = new Map<string, string>()
      filaments.forEach(f => {
        if (f.manufacturer?.id && f.manufacturer?.name) {
          mfMap.set(String(f.manufacturer.id), f.manufacturer.name)
        }
      })
      const sortedMfs = [...mfMap.entries()].sort((a, b) => a[1].localeCompare(b[1]))
      sortedMfs.forEach(([id, name]) => {
        const opt = document.createElement('option')
        opt.value = id
        opt.textContent = name
        mfSelect.appendChild(opt)
      })
      if (filterManufacturerId) mfSelect.value = filterManufacturerId

      const matSelect = document.getElementById('filter-material') as HTMLSelectElement
      const materials = new Set<string>()
      filaments.forEach(f => { if (f.type) materials.add(f.type) })
      const sortedMats = [...materials].sort()
      sortedMats.forEach(mat => {
        const opt = document.createElement('option')
        opt.value = mat
        opt.textContent = mat
        matSelect.appendChild(opt)
      })
      if (filterMaterial) matSelect.value = filterMaterial
    }
    
    async function loadFilters() {
      try {
        const [statusesRes, locationsRes, filamentsRes] = await Promise.all([
          fetch('/api/v1/spools/statuses', { credentials: 'include' }).catch(() => null),
          fetch('/api/v1/locations?page_size=200', { credentials: 'include' }),
          fetch('/api/v1/filaments?page_size=200', { credentials: 'include' }),
        ])

        if (statusesRes?.ok) {
          statuses = await statusesRes.json()
          const select = document.getElementById('filter-status') as HTMLSelectElement
          statuses.forEach((s: any) => {
            const opt = document.createElement('option')
            opt.value = s.id
            const i18nKey = `spools.status${s.key.charAt(0).toUpperCase() + s.key.slice(1)}`
            opt.textContent = t(i18nKey) || s.label
            select.appendChild(opt)
          })
        }
        
        if (locationsRes?.ok) {
          const data = await locationsRes.json()
          locations = data.items
          const select = document.getElementById('filter-location') as HTMLSelectElement
          locations.forEach((l: any) => {
            const opt = document.createElement('option')
            opt.value = l.id
            opt.textContent = l.name
            select.appendChild(opt)
          })
          if (filterLocationId) select.value = filterLocationId
        }
        
        if (filamentsRes?.ok) {
          const data = await filamentsRes.json()
          filaments = data.items
        }

        populateFilterDropdowns()
      } catch (error) {
        console.error('Failed to load filters:', error)
      }
    }
    
    async function loadSpools() {
      const { statusId } = getFilterValues()
      let url = `/api/v1/spools?page=1&page_size=200`
      if (statusId) url += `&status_id=${statusId}`
      
      try {
        const response = await fetch(url, { credentials: 'include' })
        if (!response.ok) throw new Error('Failed to fetch spools')
        const data = await response.json()
        allSpools = data.items
        if (data.total > 200) {
          const totalPages = Math.ceil(data.total / 200)
          for (let p = 2; p <= totalPages; p++) {
            let pUrl = `/api/v1/spools?page=${p}&page_size=200`
            if (statusId) pUrl += `&status_id=${statusId}`
            const res = await fetch(pUrl, { credentials: 'include' })
            if (res.ok) {
              const d = await res.json()
              allSpools = allSpools.concat(d.items)
            }
          }
        }
        applyFiltersAndRender()
      } catch (error) {
        console.error('Failed to load spools:', error)
        document.getElementById('spools-table')!.innerHTML = `
          <tr>
            <td colspan="8" style="text-align: center; color: var(--error-text);">${t('spools.failedLoad')}</td>
          </tr>
        `
      }
    }
    
    function getFilamentName(filamentId: number): string {
      const f = filaments.find(f => f.id === filamentId)
      return f ? `${f.designation} (${f.type})` : `#${filamentId}`
    }

    function getStatusLabel(statusId: number): string {
      const s = statuses.find((s: any) => s.id === statusId)
      if (!s) return `#${statusId}`
      const i18nKey = `spools.status${s.key.charAt(0).toUpperCase() + s.key.slice(1)}`
      return t(i18nKey) || s.label
    }
    
    function getLocationName(locationId: number | null): string {
      if (!locationId) return '-'
      const l = locations.find(l => l.id === locationId)
      return l ? l.name : `#${locationId}`
    }

    function getColorDots(spool: any): string {
      const fil = getFilamentForSpool(spool)
      if (!fil || !fil.colors || fil.colors.length === 0) return ''
      return fil.colors.map((fc: any) => {
        const c = fc.color
        if (!c) return ''
        return `<span title="${fc.display_name_override || c.name}" style="display: inline-block; width: 14px; height: 14px; border-radius: 50%; background: ${c.hex_code}; border: 1px solid var(--border); vertical-align: middle; margin-right: 2px;"></span>`
      }).join('')
    }

    async function loadActiveDevices() {
      try {
        const res = await fetch('/api/v1/devices/active', { credentials: 'include' })
        if (res.ok) {
          activeDevices = await res.json()
        }
      } catch (e) {
        console.error('Failed to load active devices:', e)
      }
    }

    function renderSpoolRow(s: any): string {
      const isLow = s.remaining_weight_g !== null && 
                    s.remaining_weight_g > 0 && 
                    s.remaining_weight_g <= s.low_weight_threshold_g
      const isEmpty = s.remaining_weight_g !== null && s.remaining_weight_g <= 0
      
      let weightStyle = ''
      if (isEmpty) weightStyle = 'color: var(--error-text); font-weight: 500;'
      else if (isLow) weightStyle = 'color: var(--accent-3); font-weight: 500;'

      const colorDots = getColorDots(s)
      
      const hasTag = !!s.rfid_uid
      const isOnline = activeDevices.length > 0
      const iconColor = hasTag ? 'color: #10b981;' : 'color: var(--text-muted);'
      const tooltip = isOnline ? t('rfid.writeTag') : t('rfid.noDeviceOnlineTooltip')
      
      const rfidIcon = `
        <td style="padding: 12px; text-align: center;" onclick="event.stopPropagation(); ${isOnline ? `window.openRfidModal(${s.id})` : ''}">
          <button class="fm-btn" 
                  style="border: none !important; background: transparent; padding: 4px; line-height: 0; ${iconColor} ${!isOnline ? 'cursor: not-allowed; opacity: 0.6;' : ''}" 
                  title="${tooltip}"
                  ${!isOnline ? 'disabled' : ''}>
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 135.18028 115.18283" fill="currentColor" style="vertical-align: middle;"><g transform="translate(-37.583451,-63.372624)"><path d="m 70.222963,178.33313 c -2.040926,-0.39862 -7.168348,-4.13124 -11.835405,-8.61585 -11.236022,-10.7968 -18.197641,-24.54085 -20.318866,-40.11476 -0.914987,-6.71777 -0.506732,-16.35742 0.977968,-23.09161 2.31059,-10.480198 7.418829,-20.910018 14.204507,-29.002258 4.136212,-4.93262 11.33237,-11.25913 15.203175,-13.36589 3.228084,-1.75694 6.735163,-0.32453 7.658584,3.12804 0.247595,0.92573 0.239278,1.4288 -0.04012,2.4267 -0.455391,1.6265 -1.235816,2.52818 -3.546301,4.0973 -2.718612,1.84629 -6.655458,5.21243 -8.886438,7.5982 -8.337084,8.91553 -13.388674,19.334498 -15.242672,31.438188 -0.606927,3.96229 -0.606927,12.1773 0,16.13959 2.48356,16.21374 10.951629,29.82811 24.433921,39.28314 2.570726,1.80283 3.338858,2.98296 3.338858,5.12972 0,1.75821 -0.610733,3.02689 -1.972927,4.0984 -0.557741,0.43872 -2.492716,1.15289 -2.888792,1.06621 -0.07276,-0.0159 -0.561233,-0.11273 -1.085496,-0.21512 z m 67.475117,-0.10858 c -2.76471,-1.00625 -4.15566,-3.49487 -3.42065,-6.12008 0.4554,-1.6265 1.23582,-2.52818 3.54631,-4.0973 2.71861,-1.84629 6.65545,-5.21242 8.88643,-7.5982 8.33709,-8.91553 13.38868,-19.3345 15.24267,-31.43819 0.60693,-3.96229 0.60693,-12.1773 0,-16.13959 -2.48355,-16.213738 -10.95162,-29.828108 -24.43392,-39.283138 -2.57072,-1.80283 -3.33885,-2.98296 -3.33885,-5.12972 0,-1.31289 0.13178,-1.83293 0.66238,-2.61377 1.79517,-2.64183 4.51786,-3.15763 7.48598,-1.4182 3.97325,2.32848 10.82063,8.41172 14.77065,13.12229 6.78568,8.09224 11.89391,18.52206 14.2045,29.002258 1.94688,8.83047 1.94688,19.94969 0,28.78015 -2.31059,10.4802 -7.41882,20.91002 -14.2045,29.00226 -4.09611,4.8848 -11.38152,11.30257 -15.09913,13.30093 -1.58248,0.85065 -3.08971,1.07148 -4.30187,0.6303 z M 82.288667,161.67534 c -3.491247,-1.68198 -8.945231,-6.03926 -12.155513,-9.71126 -15.69411,-17.9513 -15.69411,-44.17488 0,-62.126188 3.158005,-3.6122 8.441186,-7.84766 12.143984,-9.73567 1.364318,-0.69565 1.767927,-0.78376 3.005287,-0.65605 2.768189,0.2857 4.656699,2.35691 4.633219,5.08147 -0.0205,2.38175 -0.69894,3.22509 -4.758319,5.91501 -13.124048,8.69656 -19.171491,24.366798 -15.297406,39.638898 2.336013,9.20883 8.368434,17.12576 17.197126,22.56943 1.931479,1.19093 2.847839,2.66732 2.847839,4.58826 0,2.34706 -1.26842,4.12548 -3.488509,4.89115 -1.40241,0.48366 -2.409749,0.37261 -4.127708,-0.45505 z m 41.616663,0.50371 c -3.64893,-1.09995 -4.70592,-6.19482 -1.79359,-8.64539 0.40793,-0.34325 1.79447,-1.32171 3.08118,-2.17434 13.12405,-8.69656 19.17149,-24.3668 15.2974,-39.6389 -2.33601,-9.20883 -8.36843,-17.125758 -17.19712,-22.569428 -1.93148,-1.19093 -2.84784,-2.66732 -2.84784,-4.58826 0,-2.93076 2.27423,-5.20186 5.2083,-5.20112 2.5604,6.6e-4 10.22581,5.51481 14.56343,10.47628 18.62084,21.298968 14.66924,53.543248 -8.53546,69.647668 -3.91854,2.71953 -5.67345,3.32738 -7.7763,2.69349 z M 94.724084,144.66857 c -3.73651,-1.3527 -9.494339,-6.42263 -11.818065,-10.40613 -2.593108,-4.44529 -3.525343,-7.97857 -3.525343,-13.36145 0,-5.38289 0.932235,-8.91617 3.525343,-13.36146 2.615066,-4.48295 8.952735,-9.782198 12.504665,-10.455808 3.29005,-0.62395 5.869456,1.55226 5.886596,4.966438 0.0113,2.24217 -0.84888,3.47505 -3.540876,5.07529 -5.15981,3.06723 -8.1917,8.16578 -8.1917,13.77554 0,2.55699 0.41151,4.28393 1.6279,6.83161 1.29069,2.70331 3.67713,5.22796 6.5638,6.94392 2.556196,1.51952 3.548696,2.8606 3.568316,4.82157 0.0196,1.96239 -0.71544,3.44776 -2.189346,4.42404 -0.6571,0.43525 -1.39755,0.79135 -1.64546,0.79135 -0.2479,0 -0.79303,0.0546 -1.21141,0.12123 -0.41837,0.0667 -1.11786,-0.008 -1.55442,-0.16614 z m 17.727076,-0.0383 c -2.33935,-0.92437 -3.38589,-2.42678 -3.3982,-4.87844 -0.0113,-2.24217 0.84888,-3.47505 3.54088,-5.07529 5.15981,-3.06722 8.1917,-8.16578 8.1917,-13.77553 0,-2.557 -0.41151,-4.28394 -1.6279,-6.83161 -1.29069,-2.70332 -3.67714,-5.22796 -6.5638,-6.94393 -2.5562,-1.51952 -3.5487,-2.8606 -3.56832,-4.82157 -0.0276,-2.752898 1.59828,-4.751878 4.27095,-5.251188 1.56093,-0.29162 2.45505,-0.0203 5.24011,1.59004 2.885,1.668138 7.21182,5.989688 8.90765,8.896798 2.5931,4.44529 3.52534,7.97857 3.52534,13.36146 0,4.12378 -0.31924,6.00292 -1.59701,9.4005 -2.99381,7.96053 -12.55285,16.05496 -16.9214,14.32876 z M 101.7884,127.76482 c -2.749906,-1.37415 -4.281026,-3.829 -4.281026,-6.86381 0,-3.03481 1.53112,-5.48967 4.281026,-6.86382 5.13008,-2.56353 11.04851,1.12319 11.05705,6.8877 0.008,5.70193 -5.95367,9.39012 -11.05705,6.83993 z" /></g></svg>
          </button>
        </td>
      `

      
      return `
        <tr style="cursor: pointer;" onclick="window.location='/spools/${s.id}'">
          <td style="padding: 12px; font-weight: 500;">${t('spools.spoolId', { id: s.id })}</td>
          <td style="padding: 12px;">${colorDots} ${getFilamentName(s.filament_id)}</td>
          <td style="padding: 12px; color: var(--text-muted);">${getManufacturerName(s)}</td>
          <td style="padding: 12px; color: var(--text-muted);">${getMaterialType(s)}</td>
          <td style="padding: 12px;">${getStatusLabel(s.status_id)}</td>
          <td style="padding: 12px; font-family: monospace; ${weightStyle}">
            ${s.remaining_weight_g !== null ? s.remaining_weight_g.toFixed(0) + 'g' : '-'}
          </td>
          <td style="padding: 12px;">${getLocationName(s.location_id)}</td>
          ${rfidIcon}
        </tr>
      `
    }
    
    function renderSpools(spools: any[]) {
      const tbody = document.getElementById('spools-table')!
      if (spools.length === 0) {
        const { search, statusId, locationId, manufacturerId, material } = getFilterValues()
        const hasFilters = search || statusId || locationId || manufacturerId || material
        tbody.innerHTML = `
          <tr>
            <td colspan="8" style="text-align: center; color: var(--text-muted);">
              ${hasFilters ? t('spools.noResults') : `${t('spools.noSpools')} <a href="/spools/new" style="color: var(--accent);">${t('spools.addOne')}</a>.`}
            </td>
          </tr>
        `
        return
      }
      
      tbody.innerHTML = spools.map(s => renderSpoolRow(s)).join('')
      translatePage()
    }

    function renderGroupedSpools(spools: any[]) {
      const tbody = document.getElementById('spools-table')!

      if (spools.length === 0) {
        const { search, statusId, locationId, manufacturerId, material } = getFilterValues()
        const hasFilters = search || statusId || locationId || manufacturerId || material
        tbody.innerHTML = `
          <tr>
            <td colspan="8" style="text-align: center; color: var(--text-muted);">
              ${hasFilters ? t('spools.noResults') : `${t('spools.noSpools')} <a href="/spools/new" style="color: var(--accent);">${t('spools.addOne')}</a>.`}
            </td>
          </tr>
        `
        return
      }

      // Group by filament_id + color combination (same filament = same color + material)
      const groups = new Map<string, { label: string; colorDots: string; manufacturer: string; material: string; spools: any[] }>()

      spools.forEach(s => {
        const fil = getFilamentForSpool(s)
        const groupKey = String(s.filament_id)
        if (!groups.has(groupKey)) {
          const colorDots = getColorDots(s)
          groups.set(groupKey, {
            label: fil ? `${fil.designation} (${fil.type})` : `#${s.filament_id}`,
            colorDots,
            manufacturer: getManufacturerName(s),
            material: getMaterialType(s),
            spools: [],
          })
        }
        groups.get(groupKey)!.spools.push(s)
      })

      let html = ''
      let groupIdx = 0
      groups.forEach((group, key) => {
        const gid = `group-${groupIdx}`
        html += `
          <tr data-group="${gid}" style="background: var(--group-header-bg); font-weight: 600; cursor: pointer; user-select: none; border-left: 3px solid var(--group-header-border);" onmouseenter="this.style.background='var(--group-header-bg-hover)'" onmouseleave="this.style.background='var(--group-header-bg)'">
            <td colspan="8" style="padding: 10px 12px; color: var(--text);">
              <span data-toggle="${gid}" style="display: inline-block;">&#9660; ${group.colorDots} ${group.label}</span>
              <span style="margin-left: 12px; font-weight: 400; color: var(--text-muted); font-size: 0.85rem;">${group.manufacturer} &middot; ${group.material} &middot; ${t('spools.spoolsInGroup', { count: group.spools.length })}</span>
            </td>
          </tr>
        `
        group.spools.forEach(s => {
          html += renderSpoolRow(s).replace('<tr ', `<tr data-group-row="${gid}" `)
        })
        groupIdx++
      })

      tbody.innerHTML = html
      translatePage()

      // Wire up group toggle
      tbody.querySelectorAll('tr[data-group]').forEach(header => {
        header.addEventListener('click', () => {
          const gid = (header as HTMLElement).dataset.group!
          const toggle = header.querySelector(`span[data-toggle]`) as HTMLElement
          const rows = tbody.querySelectorAll(`tr[data-group-row="${gid}"]`)
          const isCollapsed = toggle.dataset.collapsed === 'true'
          
          if (isCollapsed) {
            toggle.dataset.collapsed = 'false'
            toggle.innerHTML = toggle.innerHTML.replace('&#9654;', '&#9660;').replace('\u25B6', '\u25BC')
            rows.forEach(r => (r as HTMLElement).style.display = '')
          } else {
            toggle.dataset.collapsed = 'true'
            toggle.innerHTML = toggle.innerHTML.replace('&#9660;', '&#9654;').replace('\u25BC', '\u25B6')
            rows.forEach(r => (r as HTMLElement).style.display = 'none')
          }
        })
      })
    }
    
    function renderPagination(total: number, page: number) {
      const totalPages = Math.ceil(total / pageSize)
      const container = document.getElementById('pagination')!
      
      if (totalPages <= 1) {
        container.innerHTML = `<div style="font-size: 0.85rem; color: var(--text-muted);">${t('spools.spoolCount', { count: total })}</div>`
        return
      }
      
      container.innerHTML = `
        <div style="font-size: 0.85rem; color: var(--text-muted);">
          ${t('common.showing')} ${((page - 1) * pageSize) + 1}-${Math.min(page * pageSize, total)} ${t('common.of')} ${total}
        </div>
        <div style="display: flex; gap: 8px;">
          <button 
            id="prev-btn"
            class="fm-btn fm-btn-outline"
            style="padding: 6px 14px; font-size: 0.85rem;"
            ${page <= 1 ? 'disabled' : ''}
          >
            ${t('common.previous')}
          </button>
          <button 
            id="next-btn"
            class="fm-btn fm-btn-outline"
            style="padding: 6px 14px; font-size: 0.85rem;"
            ${page >= totalPages ? 'disabled' : ''}
          >
            ${t('common.next')}
          </button>
        </div>
      `
      
      document.getElementById('prev-btn')?.addEventListener('click', () => {
        if (page > 1) {
          currentPage = page - 1
          renderPage()
        }
      })
      document.getElementById('next-btn')?.addEventListener('click', () => {
        if (page < totalPages) {
          currentPage = page + 1
          renderPage()
        }
      })
    }

    // Wire up filter events
    document.getElementById('filter-search')?.addEventListener('input', () => {
      if (searchTimeout) clearTimeout(searchTimeout)
      searchTimeout = setTimeout(() => applyFiltersAndRender(), 250)
    })
    document.getElementById('filter-status')?.addEventListener('change', () => loadSpools())
    document.getElementById('filter-location')?.addEventListener('change', () => applyFiltersAndRender())
    document.getElementById('filter-manufacturer')?.addEventListener('change', () => applyFiltersAndRender())
    document.getElementById('filter-material')?.addEventListener('change', () => applyFiltersAndRender())
    document.getElementById('filter-group')?.addEventListener('change', () => applyFiltersAndRender())
    
    setupSortableHeaders()
    loadFilters()
      .then(() => loadActiveDevices())
      .then(() => loadSpools())

    // RFID Modal Logic
    let currentRfidSpoolId: number | null = null
    
    ;(window as any).openRfidModal = (spoolId: number) => {
      currentRfidSpoolId = spoolId
      const modal = document.getElementById('rfid-modal')!
      const text = document.getElementById('rfid-text')!
      const deviceSelectContainer = document.getElementById('rfid-device-select-container')!
      const deviceSelect = document.getElementById('rfid-device-select') as HTMLSelectElement
      const status = document.getElementById('rfid-status')!
      const warning = document.getElementById('rfid-warning')!
      
      status.classList.add('hidden')
      
      // Check if spool already has a tag
      const spool = allSpools.find(s => s.id === spoolId)
      if (spool && spool.rfid_uid) {
        warning.classList.remove('hidden')
      } else {
        warning.classList.add('hidden')
      }

      if (activeDevices.length === 1) {
        text.textContent = t('rfid.confirmWrite', { device: activeDevices[0].name })
        deviceSelectContainer.classList.add('hidden')
      } else {
        text.textContent = t('rfid.selectDeviceToWrite')
        deviceSelectContainer.classList.remove('hidden')
        deviceSelect.innerHTML = activeDevices.map(d => `<option value="${d.id}">${d.name} (${d.ip_address})</option>`).join('')
      }
      
      modal.classList.add('open')
    }
    
    document.getElementById('rfid-cancel')?.addEventListener('click', () => {
      document.getElementById('rfid-modal')!.classList.remove('open')
    })
    
    document.getElementById('rfid-confirm')?.addEventListener('click', async () => {
      if (!currentRfidSpoolId) return
      
      const deviceId = activeDevices.length === 1 
        ? activeDevices[0].id 
        : (document.getElementById('rfid-device-select') as HTMLSelectElement).value
      
      const device = activeDevices.find(d => String(d.id) === String(deviceId))
      if (!device) return
      
      const confirmBtn = document.getElementById('rfid-confirm') as HTMLButtonElement
      const cancelBtn = document.getElementById('rfid-cancel') as HTMLButtonElement
      const status = document.getElementById('rfid-status')!
      
      confirmBtn.disabled = true
      cancelBtn.disabled = false // Keep cancel active
      
      const maxWaitSeconds = 120
      status.className = 'fm-alert fm-alert-info rfid-write-progress'
      status.classList.remove('hidden')
      status.innerHTML = `
        <div class="message-row">
          <span class="spinner"></span>
          <span>${t('rfid.writeStarted')}</span>
        </div>
        <div class="countdown-bar">
          <div class="countdown-fill green" id="countdown-fill" style="width: 100%"></div>
        </div>
        <span class="countdown-text" id="countdown-text">${maxWaitSeconds}s</span>
      `
      
      // Handle Cancel while waiting
      let isPolling = true
      const onCancel = () => {
        isPolling = false
        confirmBtn.disabled = false
        status.classList.add('hidden')
      }
      cancelBtn.addEventListener('click', onCancel, { once: true })
      
      try {
        const response = await fetch(`/api/v1/devices/${deviceId}/write-tag`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'X-CSRF-Token': getCsrfToken()
          },
          credentials: 'include',
          body: JSON.stringify({ spool_id: currentRfidSpoolId }),
        })
        
        const result = await response.json()
        
        if (response.ok && result.success) {
          // Polling: Check periodically for the write status
          const maxAttempts = 60 // 60 attempts * 2 seconds = 120 seconds max wait
          let attempts = 0
          
          const pollForResult = async () => {
            if (!isPolling) return
            
            attempts++
            
            const elapsedSeconds = attempts * 2
            const remainingSeconds = 120 - elapsedSeconds
            const percentage = Math.max(0, (remainingSeconds / 120) * 100)
            
            const fill = document.getElementById('countdown-fill')
            const text = document.getElementById('countdown-text')
            
            if (fill && text) {
              fill.style.width = percentage + '%'
              text.textContent = Math.max(0, remainingSeconds) + 's'
              
              fill.className = 'countdown-fill'
              if (percentage > 66) {
                fill.classList.add('green')
              } else if (percentage > 33) {
                fill.classList.add('yellow')
              } else {
                fill.classList.add('orange')
              }
            }
            
            try {
              const statusRes = await fetch(`/api/v1/devices/${deviceId}/write-status`, { credentials: 'include' })
              if (statusRes.ok) {
                const statusData = await statusRes.json()
                
                if (statusData.status === 'success') {
                  isPolling = false
                  
                  if (statusData.removed_from) {
                    status.textContent = t('rfid.writeSuccessWithCleanup', { source: statusData.removed_from })
                  } else {
                    status.textContent = t('rfid.writeSuccess')
                  }
                  
                  status.className = 'fm-alert fm-alert-success'
                  
                  // Reload data to see changes
                  loadSpools()
                  
                  setTimeout(() => {
                    document.getElementById('rfid-modal')!.classList.remove('open')
                    confirmBtn.disabled = false
                  }, 3000) // Longer visibility for cleanup message
                  return
                } else if (statusData.status === 'error') {
                  isPolling = false
                  status.textContent = statusData.error_message || t('rfid.writeError')
                  status.className = 'fm-alert fm-alert-error'
                  confirmBtn.disabled = false
                  return
                }
              }
            } catch (e) {
              console.error('Polling error:', e)
            }
            
            if (attempts >= maxAttempts) {
              isPolling = false
              status.textContent = t('rfid.deviceTimeout')
              status.className = 'fm-alert fm-alert-error'
              confirmBtn.disabled = false
            } else {
              setTimeout(pollForResult, 2000)
            }
          }
          
          setTimeout(pollForResult, 2000)
        } else {
          const msg = result.detail?.message || result.message || t('rfid.writeError')
          status.textContent = msg
          status.className = 'fm-alert fm-alert-error'
          confirmBtn.disabled = false
        }
      } catch (err) {
        status.textContent = t('rfid.writeError')
        status.className = 'fm-alert fm-alert-error'
        confirmBtn.disabled = false
      }
    })
  </script>
</Layout>
