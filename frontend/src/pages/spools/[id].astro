---
import Layout from '../../layouts/Layout.astro'

export function getStaticPaths() {
  return [
    {params: {id: 'detail'}},
  ];
}

const { id } = Astro.params
---

<Layout title="FilaMan - Spool">
  <div style="margin-bottom: 24px;">
    <a href="/spools" style="color: var(--accent); text-decoration: none;">&larr; <span data-i18n="spools.backToSpools">Back to Spools</span></a>
  </div>
  
  <div id="spool-content">
    <p style="color: var(--text-muted);" data-i18n="common.loading">Loading...</p>
  </div>
  
  <div id="actions-section" class="hidden" style="margin-top: 24px;">
    <h2 style="font-weight: 600; margin-bottom: 16px;" data-i18n="spools.quickActions">Quick Actions</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;">
      <button id="btn-measurement" class="fm-btn fm-btn-primary" style="background: var(--accent);" data-i18n="spools.recordWeight">
        Record Weight
      </button>
      <button id="btn-adjustment" class="fm-btn fm-btn-outline" style="border-color: var(--accent-2); color: var(--accent-2);" data-i18n="spools.adjust">
        Adjust
      </button>
      <button id="btn-status" class="fm-btn fm-btn-outline" style="border-color: var(--accent-3); color: var(--accent-3);" data-i18n="spools.changeStatus">
        Change Status
      </button>
      <button id="btn-move" class="fm-btn fm-btn-outline" data-i18n="spools.move">
        Move
      </button>
      <button id="btn-custom-fields" class="fm-btn fm-btn-outline" data-i18n="spools.manageCustomFields">
        Extra Fields
      </button>
    </div>
  </div>
  
  <div id="modal-container" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="fm-card" style="padding: 24px; width: 100%; max-width: 420px; margin: 16px;">
      <h3 id="modal-title" style="font-weight: 600; margin: 0 0 16px 0;"></h3>
      <form id="modal-form" style="display: grid; gap: 16px;">
        <div id="modal-fields"></div>
        <div id="modal-error" class="fm-alert-error hidden"></div>
        <div style="display: flex; gap: 12px;">
          <button type="submit" id="modal-submit" class="fm-btn fm-btn-primary" data-i18n="common.submit">
            Submit
          </button>
          <button type="button" id="modal-cancel" class="fm-btn fm-btn-outline" data-i18n="common.cancel">
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- RFID Modal -->
  <div id="rfid-modal" class="fm-modal-overlay">
    <div class="fm-card" style="width: 100%; max-width: 28rem; margin: 0 1rem; padding: 24px;">
      <h3 style="font-size: 1.15rem; font-weight: 600; margin-bottom: 16px;" data-i18n="rfid.writeTag">Write RFID Tag</h3>
      <div id="rfid-content">
        <p style="margin-bottom: 16px;" id="rfid-text"></p>
        <div id="rfid-device-select-container" class="hidden">
          <label for="rfid-device-select" class="fm-label" data-i18n="rfid.selectDevice">Select Device</label>
          <select id="rfid-device-select" class="fm-select" style="margin-bottom: 16px;"></select>
        </div>
        <div id="rfid-warning" class="fm-alert fm-alert-warning hidden" style="margin-bottom: 16px;" data-i18n="rfid.tagAlreadyExistsWarning"></div>
      </div>
      <div id="rfid-status" class="fm-alert hidden" style="margin-bottom: 16px;"></div>
      <div style="display: flex; gap: 12px;">
        <button id="rfid-confirm" class="fm-btn fm-btn-primary" data-i18n="common.confirm">Confirm</button>
        <button id="rfid-cancel" class="fm-btn fm-btn-outline" data-i18n="common.cancel">Cancel</button>
      </div>
    </div>
  </div>
  
  <div id="events-section" class="hidden" style="margin-top: 32px;">
    <h2 style="font-weight: 600; margin-bottom: 16px;" data-i18n="spools.eventHistory">Event History</h2>
    <div class="fm-card" style="padding: 0; overflow: hidden;">
      <table class="fm-table">
        <thead>
          <tr style="background: var(--bg-soft);">
            <th data-i18n="spools.eventType">Type</th>
            <th data-i18n="spools.eventDate">Date</th>
            <th data-i18n="spools.eventWeight">Weight</th>
            <th data-i18n="common.note">Note</th>
          </tr>
        </thead>
        <tbody id="events-table">
          <tr>
            <td colspan="4" style="text-align: center; color: var(--text-muted);" data-i18n="common.loading">Loading...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  
  <script>
    import { t, initI18n } from '../../lib/i18n'
    await initI18n()

    const id = window.location.pathname.split('/').filter(Boolean).pop()!
    if (id === 'detail') {
      window.location.href = '/spools'
    }

    let spool = null
    let statuses = []
    let locations = []
    // Local state for custom fields modal
    let modalCustomFields = []
    // RFID state
    let activeDevices = []
    let currentRfidSpoolId = null
    
    function flattenObject(obj, prefix = '', res = {}) {
      for (const key in obj) {
        if (Object.prototype.hasOwnProperty.call(obj, key)) {
          const val = obj[key]
          const newKey = prefix ? `${prefix}.${key}` : key
          if (typeof val === 'object' && val !== null) {
            flattenObject(val, newKey, res)
          } else {
            res[newKey] = String(val)
          }
        }
      }
      return res
    }

    function unflattenObject(data) {
      const result = {}
      for (const key in data) {
        if (Object.prototype.hasOwnProperty.call(data, key)) {
          const keys = key.split('.')
          let current = result
          for (let i = 0; i < keys.length; i++) {
            const k = keys[i]
            if (i === keys.length - 1) {
              const val = data[key]
              const num = Number(val)
              current[k] = !isNaN(num) && val.trim() !== '' ? num : val
            } else {
              current[k] = current[k] || {}
              current = current[k]
            }
          }
        }
      }
      return result
    }

    function getCsrfToken() {
      const match = document.cookie.match(/(?:^|;\s*)csrf_token=([^;]*)/)
      return match ? decodeURIComponent(match[1]) : ''
    }
    
    async function loadData() {
      try {
        const [spoolRes, statusesRes, locationsRes] = await Promise.all([
          fetch(`/api/v1/spools/${id}`, { credentials: 'include' }),
          fetch('/api/v1/spools/statuses', { credentials: 'include' }),
          fetch('/api/v1/locations?page_size=200', { credentials: 'include' }),
        ])
        
        if (!spoolRes.ok) {
          if (spoolRes.status === 404) {
            document.getElementById('spool-content').innerHTML = `<div style="color: var(--error-text);">${t('spools.notFound')}</div>`
            return
          }
          throw new Error('Failed to fetch spool')
        }
        
        spool = await spoolRes.json()
        
        if (statusesRes.ok) {
          statuses = await statusesRes.json()
        }
        
        if (locationsRes.ok) {
          const data = await locationsRes.json()
          locations = data.items
        }
        
        // Load active devices for RFID functionality
        const devicesRes = await fetch('/api/v1/devices/active', { credentials: 'include' })
        if (devicesRes.ok) {
          activeDevices = await devicesRes.json()
        }
        
        renderSpool()
        loadEvents()
        setupActions()
      } catch (error) {
        console.error('Failed to load spool:', error)
        document.getElementById('spool-content').innerHTML = `<div style="color: var(--error-text);">${t('spools.failedLoadSingle')}</div>`
      }
    }
    
    function getStatusLabel(statusId) {
      const s = statuses.find(s => s.id === statusId)
      if (!s) return `#${statusId}`
      const i18nKey = `spools.status${s.key.charAt(0).toUpperCase() + s.key.slice(1)}`
      return t(i18nKey) || s.label
    }
    
    function getLocationName(locationId) {
      if (!locationId) return t('spools.noLocation')
      const l = locations.find(l => l.id === locationId)
      return l ? l.name : `#${locationId}`
    }
    
    function renderSpool() {
      const isLow = spool.remaining_weight_g !== null && 
                    spool.remaining_weight_g > 0 && 
                    spool.remaining_weight_g <= spool.low_weight_threshold_g
      const isEmpty = spool.remaining_weight_g !== null && spool.remaining_weight_g <= 0
      
      let statusStyle = 'background: var(--success-bg); border-color: var(--success-border);'
      if (isEmpty) statusStyle = 'background: var(--error-bg); border-color: var(--error-border);'
      else if (isLow) statusStyle = 'background: rgba(247, 200, 106, 0.15); border: 1px solid rgba(247, 200, 106, 0.4);'
      
      document.getElementById('spool-content').innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px;">
          <div>
            <h1 style="font-size: 1.8rem; font-weight: 700; margin: 0; font-family: var(--font-serif);">${t('spools.spoolId', { id: spool.id })}</h1>
            <p style="color: var(--text-muted); margin: 4px 0 0;">${t('spools.filament')}: <a href="/filaments/${spool.filament_id}" style="color: var(--accent); text-decoration: none;">${t('spools.filament')} #${spool.filament_id}</a></p>
          </div>
          <div style="display: flex; gap: 8px;">
            <a href="/spools/${id}/edit" class="fm-btn fm-btn-outline">${t('common.edit')}</a>
            <button id="btn-rfid" class="fm-btn fm-btn-outline" style="${spool.rfid_uid ? 'color: #10b981;' : ''}" title="${t('rfid.writeTag')}">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 135.18028 115.18283" fill="currentColor"><g transform="translate(-37.583451,-63.372624)"><path d="m 70.222963,178.33313 c -2.040926,-0.39862 -7.168348,-4.13124 -11.835405,-8.61585 -11.236022,-10.7968 -18.197641,-24.54085 -20.318866,-40.11476 -0.914987,-6.71777 -0.506732,-16.35742 0.977968,-23.09161 2.31059,-10.480198 7.418829,-20.910018 14.204507,-29.002258 4.136212,-4.93262 11.33237,-11.25913 15.203175,-13.36589 3.228084,-1.75694 6.735163,-0.32453 7.658584,3.12804 0.247595,0.92573 0.239278,1.4288 -0.04012,2.4267 -0.455391,1.6265 -1.235816,2.52818 -3.546301,4.0973 -2.718612,1.84629 -6.655458,5.21243 -8.886438,7.5982 -8.337084,8.91553 -13.388674,19.334498 -15.242672,31.438188 -0.606927,3.96229 -0.606927,12.1773 0,16.13959 2.48356,16.21374 10.951629,29.82811 24.433921,39.28314 2.570726,1.80283 3.338858,2.98296 3.338858,5.12972 0,1.75821 -0.610733,3.02689 -1.972927,4.0984 -0.557741,0.43872 -2.492716,1.15289 -2.888792,1.06621 -0.07276,-0.0159 -0.561233,-0.11273 -1.085496,-0.21512 z m 67.475117,-0.10858 c -2.76471,-1.00625 -4.15566,-3.49487 -3.42065,-6.12008 0.4554,-1.6265 1.23582,-2.52818 3.54631,-4.0973 2.71861,-1.84629 6.65545,-5.21242 8.88643,-7.5982 8.33709,-8.91553 13.38868,-19.3345 15.24267,-31.43819 0.60693,-3.96229 0.60693,-12.1773 0,-16.13959 -2.48355,-16.213738 -10.95162,-29.828108 -24.43392,-39.283138 -2.57072,-1.80283 -3.33885,-2.98296 -3.33885,-5.12972 0,-1.31289 0.13178,-1.83293 0.66238,-2.61377 1.79517,-2.64183 4.51786,-3.15763 7.48598,-1.4182 3.97325,2.32848 10.82063,8.41172 14.77065,13.12229 6.78568,8.09224 11.89391,18.52206 14.2045,29.002258 1.94688,8.83047 1.94688,19.94969 0,28.78015 -2.31059,10.4802 -7.41882,20.91002 -14.2045,29.00226 -4.09611,4.8848 -11.38152,11.30257 -15.09913,13.30093 -1.58248,0.85065 -3.08971,1.07148 -4.30187,0.6303 z M 82.288667,161.67534 c -3.491247,-1.68198 -8.945231,-6.03926 -12.155513,-9.71126 -15.69411,-17.9513 -15.69411,-44.17488 0,-62.12618 6.78567,-8.09224 16.44499,-16.38479 23.33164,-20.01131 2.72186,-1.43414 5.37714,-2.42953 5.89951,-2.212 1.56001,0.64967 1.53096,2.62609 -0.06569,4.46905 -1.15898,1.33782 -3.26572,3.18779 -5.241145,4.59916 -3.65206,2.61113 -8.59355,7.03356 -10.82666,9.67475 -7.39846,8.75653 -12.13321,17.86153 -14.04709,27.02475 -1.31041,6.28054 -1.24847,14.69755 0.13891,20.265 1.56791,6.29727 4.82342,12.86434 8.48814,17.10899 1.50859,1.74719 1.72538,2.31064 1.02977,2.67659 -1.09799,0.57718 -3.12598,-0.9693 -4.54237,-3.46408 z M 45.725724,108.36183 c -4.377988,-3.88569 -10.583668,-11.74294 -13.116718,-16.63773 -5.15395,-9.96289 -6.849423,-21.59809 -4.560406,-31.34699 1.524477,-6.49288 5.290448,-13.23325 9.600608,-17.22059 2.205469,-2.04065 3.067279,-2.35039 4.334609,-1.5594 1.652289,1.03175 1.435779,3.10449 -0.53087,5.08164 -3.213617,3.23031 -5.151785,9.02393 -5.151785,15.42586 0,5.29353 0.401627,6.65234 3.380653,11.43751 5.151785,8.29079 11.461769,15.52184 18.418662,21.13037 2.299837,1.85359 2.512989,2.38389 1.200462,2.98628 -1.169932,0.53703 -3.437551,-0.41488 -5.475105,-2.28796 z M 133.66552,108.71076 c -2.04889,-1.60118 -8.58359,-8.13379 -10.97021,-10.98333 -8.16199,-9.75111 -12.66452,-19.60469 -14.04709,-30.73411 -1.31041,-6.28054 -1.24847,-14.69755 0.13891,-20.265 1.56791,-6.29727 4.82342,-12.86434 8.48814,-17.10899 1.50859,-1.74719 1.72538,-2.31064 1.02977,-2.67659 -1.09799,-0.57718 -3.12598,0.9693 -4.54237,3.46408 -1.50048,2.64418 -2.01088,4.22756 -2.01088,6.23191 0,5.29353 0.40162,6.65234 3.38065,11.43751 5.15179,8.29079 11.46177,15.52184 18.41866,21.13037 2.29984,1.85359 2.51299,2.38389 1.20046,2.98628 -0.84038,0.38579 -1.98677,0.0923 -2.98544,-0.76609 z M 82.288667,72.278996 c -3.491247,-1.68198 -8.945231,-6.03926 -12.155513,-9.71126 -15.69411,-17.9513 -15.69411,-44.17488 0,-62.12618 6.78567,-8.09224 16.44499,-16.38479 23.33164,-20.01131 2.72186,-1.43414 5.37714,-2.42953 5.89951,-2.212 1.56001,0.64967 1.53096,2.62609 -0.06569,4.46905 -1.15898,1.33782 -3.26572,3.18779 -5.241145,4.59916 -3.65206,2.61113 -8.59355,7.03356 -10.82666,9.67475 -7.39846,8.75653 -12.13321,17.86153 -14.04709,27.02475 -1.31041,6.28054 -1.24847,14.69755 0.13891,20.265 1.56791,6.29727 4.82342,12.86434 8.48814,17.10899 1.50859,1.74719 1.72538,2.31064 1.02977,2.67659 -1.09799,0.57718 -3.12598,-0.9693 -4.54237,-3.46408 z"></path></g></svg>
            </button>
            <button id="btn-delete" class="fm-btn fm-btn-danger">${t('common.delete')}</button>
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px;">
          <div class="fm-card">
            <div style="font-size: 0.85rem; color: var(--text-muted);">${t('spools.status')}</div>
            <div style="font-size: 1.1rem; font-weight: 600;">${getStatusLabel(spool.status_id)}</div>
          </div>
          <div class="fm-card" style="${statusStyle}">
            <div style="font-size: 0.85rem; color: var(--text-muted);">${t('spools.remaining')}</div>
            <div style="font-size: 1.1rem; font-weight: 600; font-family: monospace;">${spool.remaining_weight_g !== null ? spool.remaining_weight_g.toFixed(0) + 'g' : '-'}</div>
          </div>
          <div class="fm-card">
            <div style="font-size: 0.85rem; color: var(--text-muted);">${t('spools.location')}</div>
            <div style="font-size: 1.1rem; font-weight: 600;">${getLocationName(spool.location_id)}</div>
          </div>
          <div class="fm-card">
            <div style="font-size: 0.85rem; color: var(--text-muted);">${t('spools.lowThresholdLabel')}</div>
            <div style="font-size: 1.1rem; font-weight: 600;">${spool.low_weight_threshold_g}g</div>
          </div>
        </div>
        
        <div style="margin-top: 16px; display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px;">
          <div class="fm-card">
            <div style="font-size: 0.85rem; color: var(--text-muted);">${t('spools.initialWeight')}</div>
            <div style="font-size: 1.1rem; font-weight: 600;">${spool.initial_total_weight_g ? spool.initial_total_weight_g + 'g' : '-'}</div>
          </div>
          <div class="fm-card">
            <div style="font-size: 0.85rem; color: var(--text-muted);">${t('spools.emptySpool')}</div>
            <div style="font-size: 1.1rem; font-weight: 600;">${spool.empty_spool_weight_g ? spool.empty_spool_weight_g + 'g' : '-'}</div>
          </div>
          <div class="fm-card">
            <div style="font-size: 0.85rem; color: var(--text-muted);">${t('spools.rfidUid')}</div>
            <div style="font-size: 0.9rem; font-weight: 600; font-family: monospace;">${spool.rfid_uid || '-'}</div>
          </div>
          <div class="fm-card">
            <div style="font-size: 0.85rem; color: var(--text-muted);">${t('spools.externalId')}</div>
            <div style="font-size: 1.1rem; font-weight: 600;">${spool.external_id || '-'}</div>
          </div>
        </div>
        
        ${spool.lot_number ? `
          <div class="fm-card" style="margin-top: 16px;">
            <div style="font-size: 0.85rem; color: var(--text-muted);">${t('spools.lotNumber')}</div>
            <div style="font-size: 1.1rem; font-weight: 600;">${spool.lot_number}</div>
          </div>
        ` : ''}

        ${spool.custom_fields && Object.keys(spool.custom_fields).length > 0 ? `
          <div class="fm-card" style="margin-top: 16px;">
            <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 8px;">${t('common.customFields') || 'Extra Fields'}</div>
            <div>
              ${Object.entries(flattenObject(spool.custom_fields)).map(([key, value]) => `
                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border);">
                  <span style="color: var(--text-muted); font-weight: 500;">${key}</span>
                  <span style="font-family: monospace; word-break: break-all;">${value}</span>
                </div>
              `).join('')}
            </div>
          </div>
        ` : ''}
      `
      
      document.getElementById('actions-section').classList.remove('hidden')
      
      document.getElementById('btn-delete')?.addEventListener('click', async () => {
        if (!(await (window as any).__fmConfirm(t('spools.confirmDelete')))) return
        
        try {
          const response = await fetch(`/api/v1/spools/${id}`, {
            method: 'DELETE',
            headers: { 'X-CSRF-Token': getCsrfToken() },
            credentials: 'include',
          })
          
          if (response.ok) {
            window.location.href = '/spools'
          } else {
            await (window as any).__fmAlert(t('spools.failedDelete'))
          }
        } catch {
          await (window as any).__fmAlert(t('spools.failedDelete'))
        }
      })
    }
    
    async function loadEvents() {
      try {
        const response = await fetch(`/api/v1/spools/${id}/events?page_size=50`, {
          credentials: 'include',
        })
        
        if (!response.ok) throw new Error('Failed to fetch events')
        
        const data = await response.json()
        document.getElementById('events-section').classList.remove('hidden')
        renderEvents(data.items)
      } catch (error) {
        console.error('Failed to load events:', error)
      }
    }
    
    function renderEvents(events) {
      const tbody = document.getElementById('events-table')
      
      if (events.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="4" style="text-align: center; color: var(--text-muted);">${t('spools.noEvents')}</td>
          </tr>
        `
        return
      }
      
      tbody.innerHTML = events.map(e => `
        <tr>
          <td style="padding: 12px;">
            <span class="fm-pill" style="${getEventTypeStyle(e.event_type)}">${e.event_type}</span>
          </td>
          <td style="padding: 12px; font-size: 0.85rem; color: var(--text-muted);">
            ${new Date(e.event_at).toLocaleString()}
          </td>
          <td style="padding: 12px; font-family: monospace; font-size: 0.85rem;">
            ${e.measured_weight_g !== null ? e.measured_weight_g.toFixed(0) + 'g' : ''}
            ${e.delta_weight_g !== null ? (e.delta_weight_g > 0 ? '+' : '') + e.delta_weight_g.toFixed(0) + 'g' : ''}
          </td>
          <td style="padding: 12px; font-size: 0.85rem; color: var(--text-muted);">${e.note || '-'}</td>
        </tr>
      `).join('')
    }
    
    function getEventTypeStyle(type) {
      const styles = {
        measurement: 'border-color: var(--accent-2); color: var(--accent-2);',
        adjustment: 'border-color: var(--accent); color: var(--accent);',
        consumption: 'border-color: var(--accent-3); color: var(--accent-3);',
        status_change: 'border-color: var(--accent-3); color: var(--accent-3);',
        move_location: 'border-color: var(--accent); color: var(--accent);',
      }
      return styles[type] || ''
    }
    
    function setupActions() {
      document.getElementById('btn-measurement')?.addEventListener('click', () => showModal('measurement'))
      document.getElementById('btn-adjustment')?.addEventListener('click', () => showModal('adjustment'))
      document.getElementById('btn-status')?.addEventListener('click', () => showModal('status'))
      document.getElementById('btn-move')?.addEventListener('click', () => showModal('move'))
      document.getElementById('btn-custom-fields')?.addEventListener('click', () => showModal('custom_fields'))
      
      // RFID button
      document.getElementById('btn-rfid')?.addEventListener('click', () => {
        if (activeDevices.length === 0) {
          (window as any).__fmAlert(t('rfid.noDeviceOnline'))
          return
        }
        window.openRfidModal()
      })
    }
    
    // RFID Modal Logic
    ;(window as any).openRfidModal = () => {
      currentRfidSpoolId = spool.id
      const modal = document.getElementById('rfid-modal')!
      const text = document.getElementById('rfid-text')!
      const deviceSelectContainer = document.getElementById('rfid-device-select-container')!
      const deviceSelect = document.getElementById('rfid-device-select') as HTMLSelectElement
      const status = document.getElementById('rfid-status')!
      const warning = document.getElementById('rfid-warning')!
      
      status.classList.add('hidden')
      
      // Check if spool already has a tag
      if (spool.rfid_uid) {
        warning.classList.remove('hidden')
      } else {
        warning.classList.add('hidden')
      }

      if (activeDevices.length === 1) {
        text.textContent = t('rfid.confirmWrite', { device: activeDevices[0].name })
        deviceSelectContainer.classList.add('hidden')
      } else {
        text.textContent = t('rfid.selectDeviceToWrite')
        deviceSelectContainer.classList.remove('hidden')
        deviceSelect.innerHTML = activeDevices.map(d => `<option value="${d.id}">${d.name} (${d.ip_address})</option>`).join('')
      }
      
      modal.classList.add('open')
    }
    
    document.getElementById('rfid-cancel')?.addEventListener('click', () => {
      document.getElementById('rfid-modal')!.classList.remove('open')
    })
    
    document.getElementById('rfid-confirm')?.addEventListener('click', async () => {
      if (!currentRfidSpoolId) return
      
      const deviceId = activeDevices.length === 1 
        ? activeDevices[0].id 
        : (document.getElementById('rfid-device-select') as HTMLSelectElement).value
      
      const device = activeDevices.find(d => String(d.id) === String(deviceId))
      if (!device) return
      
      const confirmBtn = document.getElementById('rfid-confirm') as HTMLButtonElement
      const cancelBtn = document.getElementById('rfid-cancel') as HTMLButtonElement
      const status = document.getElementById('rfid-status')!
      
      confirmBtn.disabled = true
      cancelBtn.disabled = false
      
      const maxWaitSeconds = 120
      status.className = 'fm-alert fm-alert-info rfid-write-progress'
      status.classList.remove('hidden')
      status.innerHTML = `
        <div class="message-row">
          <span class="spinner"></span>
          <span>${t('rfid.writeStarted')}</span>
        </div>
        <div class="countdown-bar">
          <div class="countdown-fill green" id="countdown-fill" style="width: 100%"></div>
        </div>
        <span class="countdown-text" id="countdown-text">${maxWaitSeconds}s</span>
      `
      
      // Handle Cancel while waiting
      let isPolling = true
      const onCancel = () => {
        isPolling = false
        confirmBtn.disabled = false
        status.classList.add('hidden')
      }
      cancelBtn.addEventListener('click', onCancel, { once: true })
      
      try {
        const response = await fetch(`/api/v1/devices/${deviceId}/write-tag`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'X-CSRF-Token': getCsrfToken()
          },
          credentials: 'include',
          body: JSON.stringify({ spool_id: currentRfidSpoolId }),
        })

        const result = await response.json()
        
        if (response.ok && result.success) {
          // Polling: Check periodically for the write status
          const maxAttempts = 60
          let attempts = 0
          
          const pollForResult = async () => {
            if (!isPolling) return
            
            attempts++
            
            const elapsedSeconds = attempts * 2
            const remainingSeconds = 120 - elapsedSeconds
            const percentage = Math.max(0, (remainingSeconds / 120) * 100)
            
            const fill = document.getElementById('countdown-fill')
            const text = document.getElementById('countdown-text')
            
            if (fill && text) {
              fill.style.width = percentage + '%'
              text.textContent = Math.max(0, remainingSeconds) + 's'
              
              fill.className = 'countdown-fill'
              if (percentage > 66) {
                fill.classList.add('green')
              } else if (percentage > 33) {
                fill.classList.add('yellow')
              } else {
                fill.classList.add('orange')
              }
            }
            
            try {
              const statusRes = await fetch(`/api/v1/devices/${deviceId}/write-status`, {
                credentials: 'include',
              })
              const statusData = await statusRes.json()
              
              if (statusData.status === 'success') {
                isPolling = false
                status.className = 'fm-alert fm-alert-success'
                status.innerHTML = `
                  <strong>${t('rfid.writeSuccess')}</strong>
                  ${statusData.removed_from ? `<br><small>${t('rfid.removedFrom', { item: statusData.removed_from })}</small>` : ''}
                `
                confirmBtn.disabled = false
                cancelBtn.textContent = t('common.close')
                cancelBtn.removeEventListener('click', onCancel)
                cancelBtn.addEventListener('click', () => {
                  document.getElementById('rfid-modal')!.classList.remove('open')
                  loadData()
                }, { once: true })
                return
              } else if (statusData.status === 'error') {
                isPolling = false
                status.className = 'fm-alert fm-alert-error'
                status.innerHTML = `<strong>${t('rfid.writeError')}</strong><br>${statusData.error_message || ''}`
                confirmBtn.disabled = false
                return
              }
            } catch (e) {
              console.error('Status check failed:', e)
            }
            
            if (isPolling && attempts < maxAttempts) {
              setTimeout(pollForResult, 2000)
            } else if (isPolling) {
              isPolling = false
              status.className = 'fm-alert fm-alert-warning'
              status.innerHTML = `<strong>${t('rfid.writeTimeout')}</strong>`
              confirmBtn.disabled = false
            }
          }
          
          setTimeout(pollForResult, 2000)
        } else {
          status.className = 'fm-alert fm-alert-error'
          status.innerHTML = `<strong>${t('rfid.writeError')}</strong><br>${result.message || ''}`
          confirmBtn.disabled = false
        }
      } catch (error) {
        status.className = 'fm-alert fm-alert-error'
        status.innerHTML = `<strong>${t('rfid.writeError')}</strong><br>${error}`
        confirmBtn.disabled = false
      }
    })
    
    function showModal(type) {
      const container = document.getElementById('modal-container')
      const title = document.getElementById('modal-title')
      const fields = document.getElementById('modal-fields')
      const error = document.getElementById('modal-error')
      
      error.classList.add('hidden')
      fields.innerHTML = ''
      
      const titles = {
        measurement: t('spools.modalRecordWeight'),
        adjustment: t('spools.modalAdjust'),
        status: t('spools.modalChangeStatus'),
        move: t('spools.modalMove'),
        custom_fields: t('spools.manageCustomFields'),
      }
      title.textContent = titles[type]
      
      if (type === 'measurement') {
        fields.innerHTML = `
          <div style="display: grid; gap: 12px;">
            <div>
              <label class="fm-label">${t('spools.measuredWeight')}</label>
              <input type="number" id="field-weight" step="0.1" required class="fm-input">
            </div>
            <div>
              <label class="fm-label">${t('common.note')}</label>
              <input type="text" id="field-note" class="fm-input">
            </div>
          </div>
        `
      } else if (type === 'adjustment') {
        fields.innerHTML = `
          <div style="display: grid; gap: 12px;">
            <div>
              <label class="fm-label">${t('spools.adjustmentType')}</label>
              <select id="field-adjustment-type" required class="fm-select">
                <option value="tare">${t('spools.adjustSetTara')}</option>
                <option value="relative">${t('spools.adjustRelative')}</option>
                <option value="absolute">${t('spools.adjustSetRemaining')}</option>
              </select>
            </div>
            <div id="field-delta-container">
              <label class="fm-label">${t('spools.deltaWeight')}</label>
              <input type="number" id="field-delta" step="0.1" class="fm-input">
            </div>
            <div id="field-measured-container" class="hidden">
              <label class="fm-label">${t('spools.measuredWeightLabel')}</label>
              <input type="number" id="field-measured" step="0.1" class="fm-input">
            </div>
            <div>
              <label class="fm-label">${t('common.note')}</label>
              <input type="text" id="field-note" class="fm-input">
            </div>
          </div>
        `
        document.getElementById('field-adjustment-type')?.addEventListener('change', (e) => {
          const val = e.target.value
          document.getElementById('field-delta-container').classList.toggle('hidden', val !== 'relative')
          document.getElementById('field-measured-container').classList.toggle('hidden', val === 'relative')
        })
      } else if (type === 'status') {
        fields.innerHTML = `
          <div style="display: grid; gap: 12px;">
            <div>
              <label class="fm-label">${t('spools.newStatus')}</label>
              <select id="field-status" required class="fm-select">
                ${statuses.map(s => {
                  const i18nKey = `spools.status${s.key.charAt(0).toUpperCase() + s.key.slice(1)}`
                  const label = t(i18nKey) || s.label
                  return `<option value="${s.key}">${label}</option>`
                }).join('')}
              </select>
            </div>
            <div>
              <label class="fm-label">${t('common.note')}</label>
              <input type="text" id="field-note" class="fm-input">
            </div>
          </div>
        `
      } else if (type === 'move') {
        fields.innerHTML = `
          <div style="display: grid; gap: 12px;">
            <div>
              <label class="fm-label">${t('spools.newLocation')}</label>
              <select id="field-location" class="fm-select">
                <option value="">${t('spools.noLocation')}</option>
                ${locations.map(l => `<option value="${l.id}">${l.name}</option>`).join('')}
              </select>
            </div>
            <div>
              <label class="fm-label">${t('common.note')}</label>
              <input type="text" id="field-note" class="fm-input">
            </div>
          </div>
        `
      } else if (type === 'custom_fields') {
        // Init state from spool object
        if (spool.custom_fields && Object.keys(spool.custom_fields).length > 0) {
          const flat = flattenObject(spool.custom_fields)
          modalCustomFields = Object.entries(flat).map(([key, value]) => ({ key, value: String(value) }))
        } else {
          modalCustomFields = []
        }
        
        fields.innerHTML = `
          <div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <span class="fm-label" style="margin: 0;">Fields (JSON)</span>
              <button type="button" id="modal-add-field" class="fm-btn fm-btn-outline" style="font-size: 0.8rem; padding: 4px 10px;">+ Add</button>
            </div>
            <div id="modal-custom-fields-container" style="display: grid; gap: 8px; max-height: 300px; overflow-y: auto;"></div>
          </div>
        `
        
        document.getElementById('modal-add-field')?.addEventListener('click', () => {
          modalCustomFields.push({ key: '', value: '' })
          renderModalCustomFields()
        })
        
        renderModalCustomFields()
      }
      
      container.classList.remove('hidden')
      container.dataset.type = type
      
      document.getElementById('modal-cancel')?.addEventListener('click', () => {
        container.classList.add('hidden')
      })
    }

    function renderModalCustomFields() {
      const container = document.getElementById('modal-custom-fields-container')
      if (!container) return
      
      container.innerHTML = ''
      modalCustomFields.forEach((field, index) => {
        const row = document.createElement('div')
        row.style.display = 'grid'
        row.style.gridTemplateColumns = '1fr 1fr auto'
        row.style.gap = '8px'
        row.style.alignItems = 'center'
        
        row.innerHTML = `
          <input type="text" placeholder="Key" class="fm-input modal-field-key" data-index="${index}" value="${field.key}" />
          <input type="text" placeholder="Value" class="fm-input modal-field-value" data-index="${index}" value="${field.value}" />
          <button type="button" class="fm-btn fm-btn-danger modal-field-remove" data-index="${index}" style="padding: 6px 10px;">&times;</button>
        `
        container.appendChild(row)
      })

      // Wire up inputs
      document.querySelectorAll('.modal-field-key').forEach((input: any) => {
        input.addEventListener('input', (e: any) => {
          modalCustomFields[parseInt(e.target.dataset.index)].key = e.target.value
        })
      })
      document.querySelectorAll('.modal-field-value').forEach((input: any) => {
        input.addEventListener('input', (e: any) => {
          modalCustomFields[parseInt(e.target.dataset.index)].value = e.target.value
        })
      })
      
      // Wire up remove buttons
      document.querySelectorAll('.modal-field-remove').forEach((btn: any) => {
        btn.addEventListener('click', (e: any) => {
          const index = parseInt(e.target.closest('button').dataset.index)
          modalCustomFields.splice(index, 1)
          renderModalCustomFields()
        })
      })
    }
    
    document.getElementById('modal-form')?.addEventListener('submit', async (e) => {
      e.preventDefault()
      
      const container = document.getElementById('modal-container')
      const type = container.dataset.type
      const error = document.getElementById('modal-error')
      const submitBtn = document.getElementById('modal-submit')
      
      let url = ''
      let body = {}
      
      if (type === 'measurement') {
        url = `/api/v1/spools/${id}/measurements`
        body = {
          measured_weight_g: parseFloat(document.getElementById('field-weight').value),
          note: document.getElementById('field-note').value || null,
        }
      } else if (type === 'adjustment') {
        url = `/api/v1/spools/${id}/adjustments`
        const adjType = document.getElementById('field-adjustment-type').value
        body = {
          adjustment_type: adjType,
          note: document.getElementById('field-note').value || null,
        }
        if (adjType === 'relative') {
          body.delta_weight_g = parseFloat(document.getElementById('field-delta').value) || null
        } else {
          body.measured_weight_g = parseFloat(document.getElementById('field-measured').value) || null
        }
      } else if (type === 'status') {
        url = `/api/v1/spools/${id}/status`
        body = {
          status: document.getElementById('field-status').value,
          note: document.getElementById('field-note').value || null,
        }
      } else if (type === 'move') {
        url = `/api/v1/spools/${id}/move`
        const locId = document.getElementById('field-location').value
        body = {
          location_id: locId ? parseInt(locId) : null,
          note: document.getElementById('field-note').value || null,
        }
      } else if (type === 'custom_fields') {
        url = `/api/v1/spools/${id}`
        // Use PATCH for updating resource fields
        // But fetch defaults to POST if not specified, so we need to handle method
        
        const fieldsObj = {}
        modalCustomFields.forEach(f => {
          if (f.key.trim()) {
            fieldsObj[f.key.trim()] = f.value
          }
        })
        
        body = {
          custom_fields: Object.keys(fieldsObj).length > 0 ? unflattenObject(fieldsObj) : null
        }
      }
      
      error.classList.add('hidden')
      submitBtn.disabled = true
      submitBtn.textContent = t('common.submitting')
      
      try {
        const response = await fetch(url, {
          method: type === 'custom_fields' ? 'PATCH' : 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': getCsrfToken(),
          },
          credentials: 'include',
          body: JSON.stringify(body),
        })
        
        if (!response.ok) {
          const data = await response.json()
          throw new Error(data.message || t('spools.failedSubmit'))
        }
        
        container.classList.add('hidden')
        loadData()
      } catch (err) {
        error.textContent = err.message
        error.classList.remove('hidden')
      } finally {
        submitBtn.disabled = false
        submitBtn.textContent = t('common.submit')
      }
    })
    
    loadData()
  </script>
</Layout>
